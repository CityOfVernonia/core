/* His name was Bruce McNair. Copyright 2023 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{property as a,subclass as i}from"@arcgis/core/core/accessorSupport/decorators";import o from"@arcgis/core/widgets/Widget";import{tsx as d}from"@arcgis/core/widgets/support/widget";import r from"@arcgis/core/widgets/LayerList";import s from"@arcgis/core/widgets/Legend";import l from"@arcgis/core/core/Collection";import c from"@arcgis/core/portal/PortalItem";import n from"@arcgis/core/layers/Layer";const y="cov-widgets--layers",m="cov-widgets--layers_notice";let p=0,L=class extends o{constructor(e){super(e),this.addWebLayers=!1,this.state="layers",this._addLayerItems=new l}postInitialize(){const{addLayerInfos:e}=this;e&&e.forEach(this._addLayerInfo.bind(this))}onHide(){this.state="layers"}_addLayerInfo(t,a){return e(this,void 0,void 0,(function*(){const{_addLayerItems:e}=this,{id:i,url:o,title:r,snippet:s}=t;let l=d("calcite-list-item",{key:p++});e.add(l,a);const n=d("calcite-tooltip",{"close-on-click":"",label:"Add layer",slot:"tooltip"},"Add layer");if(i){const e=new c({id:i});yield e.load(),l=d("calcite-list-item",{key:p++,label:r||e.title,description:s||e.snippet},d("calcite-action",{slot:"actions-end",icon:"add-layer",scale:"s",text:"Add layer",afterCreate:a=>{a.addEventListener("click",this._addLayerFromPortalLayerInfo.bind(this,e,a,t,l))}},n))}else o&&(l=d("calcite-list-item",{key:p++,label:r,description:s},d("calcite-action",{slot:"actions-end",icon:"add-layer",scale:"s",text:"Add layer",afterCreate:e=>{e.addEventListener("click",this._addLayerFromServerLayerInfo.bind(this,o,e,t,l))}},n)));e.splice(a,1,l)}))}_addLayerFromPortalLayerInfo(e,t,a,i){const{view:{map:o},_addLayerItems:d}=this,{index:r,layerProperties:s,add:l}=a;t.loading=!0,t.disabled=!0,n.fromPortalItem({portalItem:e}).then((e=>{for(const t in s)e[t]=s[t];o.add(e,r),l&&"function"==typeof l&&l(e),d.remove(i)}))}_addLayerFromServerLayerInfo(e,t,a,i){const{view:{map:o},_addLayerItems:d}=this,{index:r,layerProperties:s,add:l}=a;t.loading=!0,t.disabled=!0,n.fromArcGISServerUrl({url:e}).then((e=>{for(const t in s)e[t]=s[t];o.add(e,r),l&&"function"==typeof l&&l(e),d.remove(i)}))}_showAddWebLayers(){return e(this,void 0,void 0,(function*(){const{_addWebLayersModal:e}=this;e||(this._addWebLayersModal=new((yield import("./AddWebLayersModal")).default)({view:this.view,container:document.createElement("calcite-modal")}),document.body.append(this._addWebLayersModal.container)),this._addWebLayersModal.container.open=!0}))}render(){const{state:e,addLayerInfos:t,addWebLayers:a,_addLayerItems:i}=this;return d("calcite-panel",{class:y,heading:"layers"===e?"Layers":"legend"===e?"Legend":"Add Layers"},d("calcite-action",{active:"layers"===e,icon:"layers",slot:"header-actions-end",text:"Layers",onclick:()=>{this.state="layers"}},d("calcite-tooltip",{"close-on-click":"",label:"Layers",placement:"bottom",slot:"tooltip"},"Layers")),d("calcite-action",{active:"legend"===e,icon:"legend",slot:"header-actions-end",text:"Legend",onclick:()=>{this.state="legend"}},d("calcite-tooltip",{"close-on-click":"",label:"Legend",placement:"bottom",slot:"tooltip"},"Legend")),t?d("calcite-action",{active:"add"===e,icon:"add-layer",slot:"header-actions-end",text:"Add layers",onclick:()=>{this.state="add"}},d("calcite-tooltip",{"close-on-click":"",label:"Add layers",placement:"bottom",slot:"tooltip"},"Add layers")):null,d("div",{hidden:"layers"!==e,afterCreate:this._createLayerList.bind(this)}),d("div",{hidden:"legend"!==e,afterCreate:this._createLegend.bind(this)}),t?d("div",{hidden:"add"!==e},i.length?d("calcite-list",null,i.toArray()):d("calcite-notice",{class:m,icon:"information",open:""},d("div",{slot:"message"},"No layers to add"))):null,a?d("calcite-fab",{hidden:"add"!==e,icon:"layer-service",slot:"add"===e?"fab":null,text:"Add Web Layers","text-enabled":"",onclick:this._showAddWebLayers.bind(this)}):null)}_createLayerList(e){new r({view:this.view,container:e})}_createLegend(e){new s({view:this.view,container:e})}};t([a()],L.prototype,"state",void 0),L=t([i("cov.widgets.Layers")],L);export default L;