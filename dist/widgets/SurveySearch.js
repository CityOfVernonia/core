/* His name was Bruce McNair. Copyright 2023 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{subclass as i,property as l}from"@arcgis/core/core/accessorSupport/decorators";import s from"@arcgis/core/widgets/Widget";import{tsx as r}from"@arcgis/core/widgets/support/widget";import o from"@arcgis/core/core/Collection";import{geodesicBuffer as c}from"@arcgis/core/geometry/geometryEngine";import n from"@arcgis/core/layers/GraphicsLayer";import{SimpleFillSymbol as a}from"@arcgis/core/symbols";const d="cov-widgets--survey-search_content",u="cov-widgets--survey-search_content-searching",h="esri-widget__table";let p=0,v=class extends s{constructor(e){super(e),this._graphics=new n({listMode:"hide"}),this._results=new o,this._selectedFeatureSymbol=new a({color:[20,158,206,.5],outline:{color:[20,158,206],width:2}}),this._selectedResult=null,this._selectedSymbol=new a({color:[255,222,62,.3],outline:{color:[255,222,62],width:2}}),this._resultSymbol=new a({color:[237,81,81,.05],outline:{color:[237,81,81],width:1}}),this._viewState="ready"}postInitialize(){const{view:{map:e},_graphics:t}=this;e.add(t),this.addHandles(this.watch(["_viewState","_visible","_selectedFeature"],(()=>{const{taxLots:e,_viewState:t,_visible:i,_selectedFeature:l}=this;"results"!==t&&"searching"!==t&&"info"!==t&&"error"!==t&&(this._viewState=i&&l&&l.layer===e?"selected":"ready")})))}onHide(){this._clear()}_clear(){const{_results:e,_graphics:t}=this;e.removeAll(),t.removeAll(),this._selectedResult=null,this._viewState="ready"}_search(){return e(this,void 0,void 0,(function*(){const{view:e,view:{spatialReference:t},taxLots:i,taxLots:{objectIdField:l},surveys:s,_selectedFeature:o,_selectedFeatureSymbol:n,_resultSymbol:a,_results:d,_graphics:u,_graphics:{graphics:h}}=this;d.removeAll(),u.removeAll(),this._viewState="searching";const v=(yield i.queryFeatures({where:`${l} = ${o.attributes[l]}`,returnGeometry:!0,outSpatialReference:t})).features[0];if(v.symbol=n.clone(),h.add(v),!v)return void(this._viewState="error");const _=(yield s.queryFeatures({geometry:c(v.geometry,10,"feet"),outFields:["*"],returnGeometry:!0,outSpatialReference:t})).features;_?(e.closePopup(),_.sort(((e,t)=>e.attributes.Timestamp>t.attributes.Timestamp?-1:1)),_.forEach((e=>{const{attributes:{Subdivision:t,SurveyId:i,SurveyDate:l,SurveyType:s,SurveyUrl:o}}=e,c=t||i;e.symbol=a.clone(),u.add(e),d.add(r("calcite-list-item",{key:p++,label:c,description:`${s} - ${l}`,afterCreate:t=>{t.addEventListener("calciteListItemSelect",this._setSelectedResult.bind(this,e))}},r("calcite-action",{icon:"information",slot:"actions-end",text:"View info",afterCreate:t=>{t.addEventListener("click",(()=>{this._infoFeature=e,this._viewState="info"}))}},r("calcite-tooltip",{"close-on-click":"",placement:"leading",slot:"tooltip"},"Info")),r("calcite-action",{slot:"actions-end",icon:"file-pdf",text:"View PDF",afterCreate:e=>{e.addEventListener("click",(()=>{window.open(o,"_blank")}))}},r("calcite-tooltip",{"close-on-click":"",placement:"leading",slot:"tooltip"},"View PDF"))))})),e.goTo(u.graphics),setTimeout((()=>{this._viewState="results"}),1e3)):this._viewState="error"}))}_setSelectedResult(e){const{_selectedResult:t,_selectedSymbol:i,_resultSymbol:l,_graphics:{graphics:s}}=this;t&&(t.symbol=l.clone()),this._selectedResult=e,e.symbol=i.clone(),s.reorder(e,s.length-1)}render(){const{_infoFeature:e,_viewState:t,_selectedFeature:i,_results:l}=this;return r("calcite-panel",{heading:"Survey Search"},r("div",{class:d,hidden:"ready"!==t},r("calcite-notice",{icon:"cursor-click",open:""},r("div",{slot:"message"},"Select a tax lot in the map to search for related surveys and plats."))),r("div",{class:d,hidden:"selected"!==t},i?r("calcite-notice",{icon:"search",open:""},r("div",{slot:"message"},i.attributes.TAXLOT_ID,r("br",null),i.attributes.OWNER)):null),r("calcite-button",{hidden:"selected"!==t,slot:"selected"===t?"footer":null,width:"full",onclick:this._search.bind(this)},"Search Surveys"),r("div",{class:u,hidden:"searching"!==t},r("calcite-progress",{text:"Searching related surveys",type:"indeterminate"})),r("div",{hidden:"results"!==t},r("calcite-list",null,l.toArray())),r("calcite-button",{appearance:"outline",hidden:"results"!==t,slot:"results"===t?"footer":null,width:"full",onclick:this._clear.bind(this)},"Clear"),this._renderInfo(),r("calcite-button",{appearance:"outline",hidden:"info"!==t,slot:"info"===t?"footer":null,width:"full",onclick:()=>{this._viewState="results"}},"Back"),r("calcite-button",{hidden:"info"!==t,slot:"info"===t?"footer":null,width:"full",onclick:()=>{e&&window.open(e.attributes.SurveyUrl,"_blank")}},"View PDF"),r("div",{class:d,hidden:"error"!==t},r("calcite-notice",{icon:"exclamation-mark-circle",kind:"danger",open:""},r("div",{slot:"message"},"An error occurred searching surveys."),r("calcite-link",{onclick:this._clear.bind(this),slot:"link"},"Try again"))))}_renderInfo(){const{_infoFeature:e,_viewState:t}=this;if(!e||"info"!==t)return null;const{SurveyType:i,SurveyId:l,SurveyDate:s,FileDate:o,Comments:c,Sheets:n,Subdivision:a,Client:d,Firm:u}=e.attributes;return this._setSelectedResult(e),r("table",{key:p++,class:h},r("tr",null,r("th",null,"Id"),r("td",null,l)),r("tr",null,r("th",null,"Type"),r("td",null,i)),a?r("tr",null,r("th",null,"Name"),r("td",null,a)):null,r("tr",null,r("th",null,"Client"),r("td",null,d)),r("tr",null,r("th",null,"Firm"),r("td",null,u)),r("tr",null,r("th",null,"Date"),r("td",null,s)),r("tr",null,r("th",null,"Filed"),r("td",null,o)),r("tr",null,r("th",null,"Comments"),r("td",null,c)),r("tr",null,r("th",null,"Pages"),r("td",null,n)))}};t([l({aliasOf:"view.popup.selectedFeature"})],v.prototype,"_selectedFeature",void 0),t([l()],v.prototype,"_selectedResult",void 0),t([l()],v.prototype,"_viewState",void 0),t([l({aliasOf:"view.popup.visible"})],v.prototype,"_visible",void 0),v=t([i("cov.widgets.SurveySearch")],v);export default v;