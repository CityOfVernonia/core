/* His name was Bruce McNair. Copyright 2024 City of Vernonia, Oregon. */
import{__awaiter as t,__decorate as e}from"tslib";import i from"@arcgis/core/core/Collection";import{subclass as a,property as n}from"@arcgis/core/core/accessorSupport/decorators";import o from"@arcgis/core/widgets/Widget";import{tsx as l}from"@arcgis/core/widgets/support/widget";const s={content:"padding: var(--calcite-font-size--2);",resultButton:"margin-top: var(--calcite-font-size--2);",snapshotResult:"width: 100%; margin-top: var(--calcite-font-size--2); display: flex; flex-flow: row; justify-content: flex-end; background-size: cover; background-repeat: no-repeat; background-position: center center; box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04); border-inline-start: 2px solid var(--calcite-color-brand);"},r="Map Print",c="Map Snapshot";let p=0,d=class extends o{constructor(t){super(t),this.layouts={"Letter ANSI A Landscape":"Letter Landscape","Letter ANSI A Portrait":"Letter Portrait","Tabloid ANSI B Landscape":"Tabloid Landscape","Tabloid ANSI B Portrait":"Tabloid Portrait"},this.mode="default",this.printServiceUrl="https://utility.arcgisonline.com/arcgis/rest/services/Utilities/PrintingTools/GPServer/Export%20Web%20Map%20Task",this._state="print",this._printResults=new i,this._snapshotResults=new i}postInitialize(){return t(this,void 0,void 0,(function*(){const{mode:t,printServiceUrl:e,view:i}=this;"snapshot"===t&&(this._state="snapshot"),"default"!==t&&"snapshot"!==t||(this._photoModal=new((yield import("./PhotoModal")).default)),"default"!==t&&"print"!==t||(this._printer=new((yield import("@arcgis/core/widgets/Print/PrintViewModel")).default)({printServiceUrl:e,view:i}),this._PrintTemplate=(yield import("@arcgis/core/rest/support/PrintTemplate")).default)}))}_setState(t){this._state=t}_print(){const{container:t,_printer:e,_PrintTemplate:i,_printResults:a}=this,n=t.querySelector('[data-print-snapshot="print title"]').value||r,o=t.querySelector('[data-print-snapshot="print layout"]').selectedOption.value,c={element:l("calcite-button",{key:p++,style:s.resultButton,width:"full",appearance:"transparent",loading:""},n)};a.add(c),e.print(new i({format:"pdf",layout:o,layoutOptions:{titleText:n}})).then((t=>{c.element=l("calcite-button",{key:p++,style:s.resultButton,width:"full",appearance:"transparent","icon-start":"download",afterCreate:e=>{e.addEventListener("click",(()=>{window.open(t.url,"_blank")}))}},n)})).catch((t=>{console.log(t),c.element=l("calcite-button",{key:p++,style:s.resultButton,width:"full",kind:"danger",disabled:"",appearance:"transparent","icon-start":"exclamation-mark-triangle"},n)})).then(this.scheduleRender.bind(this))}_snapshot(){return t(this,void 0,void 0,(function*(){const{container:t,view:e,_snapshotResults:i,_photoModal:a}=this,n=t.querySelector('[data-print-snapshot="snapshot title"]').value||r,o=t.querySelector('[data-print-snapshot="snapshot format"]').value,c=`${n}.${o}`,d=(yield e.takeScreenshot({format:o})).data,h=this._dataUrl(d,n,o);i.add(l("div",{key:p++,style:this.classes(s.snapshotResult,`background-image: url(${h});`)},l("calcite-action",{icon:"image",text:"View",onclick:a.show.bind(a,c,h)}),l("calcite-action",{icon:"download",text:"Download",onclick:a.download.bind(a,c,h)})))}))}_dataUrl(t,e,i){const a=document.createElement("canvas"),n=a.getContext("2d");return a.width=t.width,a.height=t.height,n.putImageData(t,0,0),n.font="bold 20px Arial",n.strokeStyle="#fff",n.strokeText(`${e}`,5,t.height-5,t.width-5),n.font="bold 20px Arial",n.fillStyle="#000",n.fillText(`${e}`,5,t.height-5,t.width-5),a.toDataURL("jpg"===i?"image/jpeg":"image/png")}render(){const{mode:t,_state:e,_printResults:i,_snapshotResults:a}=this;return l("calcite-panel",{heading:"print"===e?"Print":"Snapshot"},"default"===t?[l("calcite-action",{active:"print"===e,icon:"print",slot:"header-actions-end",text:"Print",onclick:this._setState.bind(this,"print")},l("calcite-tooltip",{"close-on-click":"",label:"Print",placement:"bottom",slot:"tooltip"},"Print")),l("calcite-action",{active:"snapshot"===e,icon:"image",slot:"header-actions-end",text:"Snapshot",onclick:this._setState.bind(this,"snapshot")},l("calcite-tooltip",{"close-on-click":"",label:"Snapshot",placement:"bottom",slot:"tooltip"},"Snapshot"))]:null,"snapshot"!==t?l("div",{hidden:"print"!==e,style:s.content},l("calcite-label",null,"Title",l("calcite-input",{"data-print-snapshot":"print title",type:"text",value:r})),l("calcite-label",null,"Layout",l("calcite-select",{"data-print-snapshot":"print layout"},this._renderLayoutOptions())),l("calcite-button",{width:"full",onclick:this._print.bind(this)},"Print"),i.map((t=>t.element)).toArray()):null,"print"!==t?l("div",{hidden:"snapshot"!==e,style:s.content},l("calcite-label",null,"Title",l("calcite-input",{"data-print-snapshot":"snapshot title",type:"text",value:c})),l("calcite-label",null,"Format",l("calcite-segmented-control",{"data-print-snapshot":"snapshot format"},l("calcite-segmented-control-item",{value:"jpg",checked:""},"JPG"),l("calcite-segmented-control-item",{value:"png"},"PNG"))),l("calcite-button",{width:"full",onclick:this._snapshot.bind(this)},"Snapshot"),a.toArray()):null)}_renderLayoutOptions(){const{layouts:t}=this,e=[];for(const i in t)e.push(l("calcite-option",{label:t[i],value:i}));return e}};e([n()],d.prototype,"_state",void 0),d=e([a("cov.widgets.PrintSnapshot")],d);export default d;