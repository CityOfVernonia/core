/* His name was Bruce McNair. Copyright 2023 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{subclass as i,property as a}from"@arcgis/core/core/accessorSupport/decorators";import l from"@arcgis/core/widgets/Widget";import{tsx as r}from"@arcgis/core/widgets/support/widget";import o from"@arcgis/core/PopupTemplate";import s from"../support/georeferencedImage";const n="padding: 0.75rem;",c="display: flex; flex-flow: row; justify-content: space-between; margin: -1rem 0.35rem 0; font-size: var(--calcite-font-size--2);",u="display: flex; flex-flow: row; gap: 0.75rem; width: 100%; padding: 0.75rem;";let d=0,p=class extends l{constructor(e){super(e),this.showSwitch=!0,this._imageLayerInfos=[],this._imageLayerInfo=null,this._opacity=.4,this._options=[r("calcite-option",{key:d++,value:"none",selected:""},"None")],this._loading=!1}postInitialize(){return e(this,void 0,void 0,(function*(){const{view:e,view:{popup:t},layer:i,titleAttributeField:a,fileAttributeField:l,urlAttributeField:s,_imageLayerInfos:n,_options:c}=this;i.popupTemplate=new o({outFields:["*"],title:`{${a}}`,content:e=>{const i=document.createElement("div");return new h({graphic:e.graphic,container:i,fileAttributeField:l,titleAttributeField:a,urlAttributeField:s}).on("show",(e=>{this._show(e),t.close(),t.clear&&"function"==typeof t.clear&&t.clear()})),i}}),yield i.when();const u=yield i.queryFeatures({where:"1 = 1",outFields:["*"],returnGeometry:!0,outSpatialReference:e.spatialReference});u.features.sort(((e,t)=>e.attributes.name<t.attributes.name?-1:1)),u.features.forEach((e=>{const{titleAttributeField:t,fileAttributeField:i}=this,{attributes:a}=e;n.push({feature:e,fileName:a[i]}),c.push(r("calcite-option",{key:d++,value:a[i]},a[t]))})),this.scheduleRender(),this.own(this.watch("_opacity",(e=>{n.forEach((t=>{const{layer:i}=t;i&&(i.opacity=e)}))})))}))}_show(e){const{view:t,_imageLayerInfos:i}=this;this._imageLayerInfo=null,i.forEach((i=>{const{layer:a,fileName:l,feature:r}=i;a&&l===e?(this._imageLayerInfo=i,a.visible=!0,t.goTo(r)):a||l!==e?a&&(a.visible=!1):(this._loading=!0,this._load(i))}))}_load(t){return e(this,void 0,void 0,(function*(){const{view:e,imageUrlTemplate:i,fileAttributeField:a,titleAttributeField:l,_opacity:r}=this,{feature:o,feature:{attributes:n}}=t,c=yield s(i.replace(`{${a}}`,n[a]),{opacity:r,title:`Tax Map ${n[l]}`});t.layer=c,this._imageLayerInfo=t,e.map.add(c,0),e.goTo(o),this._loading=!1}))}_selectAfterCreate(e){e.addEventListener("calciteSelectChange",(()=>{this._show(e.selectedOption.value)})),this.own(this.watch("_imageLayerInfo",(t=>{console.log(t,e),e.value=t?t.fileName:"none"})))}render(){const{layer:e,titleAttributeField:t,urlAttributeField:i,showSwitch:a,_imageLayerInfo:l,_opacity:o,_options:s,_loading:u}=this;return r("calcite-panel",{heading:"Tax Maps"},l?r("calcite-button",{appearance:"outline",href:l.feature.attributes[i],"icon-start":"file-pdf",slot:"footer",target:"_blank",width:"full"},`View ${l.feature.attributes[t]}`):null,r("div",{style:n},a?r("calcite-label",{layout:"inline"},r("calcite-switch",{checked:e.visible,afterCreate:t=>{t.addEventListener("calciteSwitchChange",(()=>{e.visible=t.checked}))}}),"Tax map boundaries"):null,r("calcite-label",{style:l?"":"--calcite-label-margin-bottom: 0;"},"Select tax map",r("calcite-select",{disabled:u,afterCreate:this._selectAfterCreate.bind(this)},s)),r("calcite-label",{hidden:!l,style:"--calcite-label-margin-bottom: 0;"},"Layer opacity",r("calcite-slider",{min:"0.2",max:"1",snap:"",step:"0.1",value:o,afterCreate:e=>{e.addEventListener("calciteSliderInput",(()=>{this._opacity=e.value}))}}),r("div",{style:c},r("span",null,"min"),r("span",null,"max")))))}};t([a()],p.prototype,"_imageLayerInfo",void 0),t([a()],p.prototype,"_opacity",void 0),t([a()],p.prototype,"_loading",void 0),p=t([i("cov.widgets.TaxMaps")],p);export default p;let h=class extends l{constructor(e){super(e)}render(){const{graphic:{attributes:e},fileAttributeField:t,titleAttributeField:i,urlAttributeField:a}=this;return r("div",{style:u},r("calcite-button",{"icon-start":"image",width:"full",onclick:()=>{this.emit("show",e[t])}},`Show ${e[i]}`),r("calcite-button",{appearance:"outline",href:e[a],"icon-start":"file-pdf",target:"_blank",width:"full"},`View ${e[i]}`))}};h=t([i("TaxMapPopup")],h);