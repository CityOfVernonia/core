/* His name was Bruce McNair. Copyright 2023 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{subclass as l}from"@arcgis/core/core/accessorSupport/decorators";import a from"@arcgis/core/widgets/Widget";import{tsx as i}from"@arcgis/core/widgets/support/widget";import c from"@arcgis/core/layers/Layer";import o from"@arcgis/core/portal/PortalItem";import s from"@arcgis/core/core/Collection";import{publish as r}from"pubsub-js";import{attributePopup as d}from"../support/layers";const n="cov-widgets--add-layers-modal_form";let u=0,p=class extends a{constructor(e){super(e),this._addLayerItems=new s}postInitialize(){const{addLayerInfos:e}=this;e&&e.forEach(this._addLayerInfo.bind(this))}_add(t){return e(this,void 0,void 0,(function*(){t.preventDefault();const{container:l,view:a,view:{map:i}}=this,o=new RegExp(/https:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&//=]*)/),s=t.target,n=s.querySelector("calcite-select"),u=n.selectedOption.value,p=s.querySelector("calcite-input"),y=p.value,m=s.querySelector("calcite-input-message"),b=s.querySelector('calcite-button[type="submit"]'),f=(t,c)=>e(this,void 0,void 0,(function*(){i.add(t),l.open=!1,yield t.when(),a.goTo(t.fullExtent),n.disabled=!1,p.disabled=!1,b.disabled=!1,p.value="",p.status="valid",m.hidden=!0,r("shell-application-alert",{icon:"check",duration:"fast",label:"add layers alert",message:c}),"feature"!==t.type&&"map-image"!==t.type&&"geojson"!==t.type||d(t)})),h=e=>{n.disabled=!1,p.disabled=!1,b.disabled=!1,p.status="invalid",p.setFocus(),m.innerHTML=e,m.hidden=!1};if(y)if(y.match(o))switch(n.disabled=!0,p.disabled=!0,b.disabled=!0,u){case"arcgis":c.fromArcGISServerUrl({url:y}).then((e=>{f(e,`${e.title} successfully added`)})).catch((e=>{console.log(e),h("Invalid service URL")}));break;case"geojson":{const t=new((yield import("@arcgis/core/layers/GeoJSONLayer")).default)({url:y});t.load().then((()=>e(this,void 0,void 0,(function*(){f(t,"GeoJSON layer successfully added")})))).catch((e=>{console.log(e),h("Invalid GeoJSON URL")}));break}case"kml":{const e=new((yield import("@arcgis/core/layers/KMLLayer")).default)({url:y});e.load().then((()=>{f(e,"KLM layer successfully added")})).catch((e=>{console.log(e),h("Invalid KML URL")}));break}}else h("Invalid URL");else h("URL required")}))}_addLayerInfo(t,l){return e(this,void 0,void 0,(function*(){const{_addLayerItems:e}=this,{id:a,url:c,title:s,snippet:r}=t;let d=i("calcite-list-item",{key:u++});e.add(d,l);const n=i("calcite-tooltip",{"close-on-click":"",label:"Add layer",slot:"tooltip"},"Add layer");if(a){const e=new o({id:a});yield e.load(),d=i("calcite-list-item",{key:u++,label:s||e.title,description:r||e.snippet},i("calcite-action",{slot:"actions-end",icon:"add-layer",text:"Add layer",afterCreate:e=>{}},n))}else c&&(d=i("calcite-list-item",{key:u++,label:s,description:r},i("calcite-action",{slot:"actions-end",icon:"add-layer",text:"Add layer",afterCreate:e=>{}},n)));e.splice(l,1,d)}))}render(){const{addLayerInfos:e,_addLayerItems:t}=this;return i("calcite-modal",{style:"--calcite-modal-content-padding: 0.25rem;",width:"s"},i("div",{slot:"header"},"Add layers"),i("calcite-tabs",{layout:"center",slot:"content"},i("calcite-tab-nav",{slot:"title-group"},e?i("calcite-tab-title",{selected:e},"Layers"):null,i("calcite-tab-title",{selected:!e},"Web"),i("calcite-tab-title",null,"Search")),e?i("calcite-tab",{selected:e},i("calcite-list",null,t.toArray())):null,i("calcite-tab",{selected:!e},i("form",{class:n,onsubmit:this._add.bind(this)},i("calcite-label",null,"Type",i("calcite-select",null,i("calcite-option",{label:"ArcGIS web service",value:"arcgis"}),i("calcite-option",{label:"GeoJSON",value:"geojson"}),i("calcite-option",{label:"KML",value:"kml"}))),i("calcite-label",null,"URL",i("calcite-input",{type:"text",placeholder:"https://<web service url>"}),i("calcite-input-message",{hidden:!0,icon:"",status:"invalid"})),i("calcite-button",{type:"submit"},"Add"))),i("calcite-tab",null,i("calcite-notice",{icon:"plane",open:""},i("div",{slot:"message"},"Cross continents quickly")))))}};p=t([l("cov.widgets.AddLayersModal")],p);export default p;