/* His name was Bruce McNair. Copyright 2025 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{watch as i}from"@arcgis/core/core/reactiveUtils";import{property as a,subclass as r}from"@arcgis/core/core/accessorSupport/decorators";import o from"@arcgis/core/widgets/Widget";import{tsx as s}from"@arcgis/core/widgets/support/widget";import l from"@arcgis/core/core/Collection";import c from"@arcgis/core/layers/GroupLayer";import n from"./../support/georeferencedImage";import p from"@arcgis/core/PopupTemplate";let d=0;const u="https://cityofvernonia.github.io/geospatial-data/tax-maps/files/jpg/{taxmap}.jpg";let h=class extends o{constructor(e){super(e),this._infos=new l,this._layer=new c({listMode:"hide"}),this._opacity=.4,this._options=new l([s("calcite-option",{key:d++,selected:!0,value:""},"None")])}postInitialize(){return e(this,void 0,void 0,function*(){const{layer:e,view:t,_infos:a,_layer:r,_options:o}=this;e.visible=!1,e.popupEnabled=!0,e.popupTemplate=new p({outFields:["*"],title:"Tax Map",content:e=>{const t=new y({graphic:e.graphic});return t.on("show",e=>{const t=this.container.querySelector("calcite-select");t&&(t.value=e,this._showLayer(e))}),t.container}}),this.addHandles(i(()=>this.visible,i=>{e.visible=i,i||t.closePopup()})),yield e.when();const l=(yield e.queryFeatures({where:"1 = 1",outFields:["*"],returnGeometry:!0,outSpatialReference:t.spatialReference})).features;l.sort((e,t)=>e.attributes.name<t.attributes.name?-1:1),l.forEach(e=>{const{name:t,taxmap:i}=e.attributes;a.add({feature:e,taxmap:i}),o.add(s("calcite-option",{key:d++,value:i},t))}),t.map&&t.map.add(r,0),this.addHandles(i(()=>this._opacity,e=>{const{_visibleLayer:t}=this;t&&(t.opacity=e)}))})}_showLayer(t){return e(this,void 0,void 0,function*(){const{view:e,_infos:i,_layer:a,_opacity:r,_visibleLayer:o}=this;if(e.closePopup(),o&&(o.visible=!1),""===t)return void(this._visibleLayer=null);const s=i.find(e=>e.taxmap===t);if(!s)return;const{feature:l,layer:c}=s;if(!c)try{s.layer=yield n(u.replace("{taxmap}",t)),a.add(s.layer)}catch(e){console.log(e)}s.layer&&(s.layer.opacity=r,s.layer.visible=!0,this._visibleLayer=s.layer,e.goTo(l))})}_showPdf(){const{_infos:e,_visibleLayer:t}=this;if(!t)return;const i=e.find(e=>{const{layer:i}=e;return!(!i||i!==t)});i&&window.open(i.feature.attributes.county_url,"_blank")}render(){const{_options:e,_visibleLayer:t}=this;return s("calcite-panel",{heading:"Tax Maps",style:"--calcite-panel-space: 0.75rem; --calcite-panel-background-color: var(--calcite-color-foreground-1);"},s("calcite-label",{style:t?"":"--calcite-label-margin-bottom: 0;"},"Select tax map",s("calcite-select",{afterCreate:this._selectAfterCreate.bind(this)},e.toArray())),s("calcite-label",{hidden:!t,style:"--calcite-label-margin-bottom: 0;"},"Layer opacity",s("calcite-slider",{afterCreate:this._sliderAfterCreate.bind(this)})),s("calcite-button",{appearance:"outline",hidden:!t,"icon-start":"file-pdf",slot:t?"footer":null,width:"full",onclick:this._showPdf.bind(this)},"View PDF"))}_selectAfterCreate(e){e.addEventListener("calciteSelectChange",()=>{this._showLayer(e.selectedOption.value)})}_sliderAfterCreate(e){Object.assign(e,{max:100,min:25,value:40,step:5,snap:!0,ticks:25,labelTicks:!0,labelFormatter:e=>`${e}%`}),e.addEventListener("calciteSliderInput",()=>{this._opacity=e.value/100})}};t([a()],h.prototype,"_opacity",void 0),t([a()],h.prototype,"_visibleLayer",void 0),h=t([r("cov.components.TaxMaps")],h);export default h;class y extends o{get container(){return this._container}set container(e){this._container=e}constructor(e){super(e),this._container=document.createElement("table"),this.graphic=e.graphic}render(){const{graphic:{attributes:{name:e,taxmap:t,county_url:i}}}=this;return s("table",{class:"esri-widget__table"},s("tr",null,s("th",null,"Tax map"),s("td",null,s("calcite-link",{onclick:()=>{this.emit("show",t)}},"Show ",e))),s("tr",null,s("th",null,"Files"),s("td",null,s("calcite-link",{href:i,target:"_blank"},"View PDF"),"   ",s("calcite-link",{href:u.replace("{taxmap}",t),target:"_blank"},"View JPG"))))}}