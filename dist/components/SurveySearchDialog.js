/* His name was Bruce McNair. Copyright 2025 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{subclass as r}from"@arcgis/core/core/accessorSupport/decorators";import l from"@arcgis/core/widgets/Widget";import{tsx as i}from"@arcgis/core/widgets/support/widget";import o from"@arcgis/core/core/Collection";let s=0,n=class extends l{get container(){return this._container}set container(e){this._container=e}constructor(e){super(e),this._container=document.createElement("calcite-dialog"),this._abortController=null,this._results=new o,this._types=new o([i("calcite-option",{selected:!0,value:"all"},"All survey types")]),this.container=this._container,document.body.appendChild(this.container)}postInitialize(){return e(this,void 0,void 0,(function*(){const{container:e,surveys:t,_types:r}=this;t.loaded||(yield t.load());const l=[];(yield t.queryFeatures({where:"1 = 1",outFields:["SurveyType"],returnGeometry:!1})).features.forEach((e=>{const t=e.attributes.SurveyType;t&&!l.includes(t)&&l.push(t)})),l.sort(),l.forEach((e=>{r.add(i("calcite-option",{key:s++,value:e},e))})),e.addEventListener("calciteDialogClose",this._close.bind(this))}))}_abort(){const{_abortController:e}=this;e&&(e.abort(),this._abortController=null)}_close(){const{container:e,_input:t,_results:r,_select:l}=this;r.removeAll(),t.value="",l.value="all",e.open=!1}_search(){return e(this,void 0,void 0,(function*(){const{surveys:e,_input:t,_results:r,_select:l}=this,o=t.value,n=l.selectedOption.value;if(this._abort(),!o||o.length<3)return void r.removeAll();const a=new AbortController,{signal:c}=a;this._abortController=a;let u=`((LOWER(SurveyId) like '%${o.toLowerCase()}%') OR (LOWER(Subdivision) like '%${o.toLowerCase()}%'))`;"all"!==n&&(u+=` AND (SurveyType = '${n}')`);try{const t=(yield e.queryFeatures({where:u,outFields:["*"],num:10,returnGeometry:!1},{signal:c})).features;r.removeAll(),t.length&&t.forEach((e=>{const{attributes:{Client:t,Comments:l,FileDate:o,Firm:n,SurveyDate:a,SurveyType:c,Sheets:u,Subdivision:d,SurveyId:h,SurveyUrl:p}}=e;r.add(i("calcite-list-item",{description:`${c} - ${a}`,key:s++,label:d?`${d} (${h})`:h},i("calcite-action",{slot:"actions-end",icon:"file-pdf",text:"View PDF",afterCreate:e=>{e.addEventListener("click",(()=>{window.open(p,"_blank")}))}}),i("table",{class:"esri-widget__table"},i("tr",null,i("th",null,"Client"),i("td",null,t)),i("tr",null,i("th",null,"Firm"),i("td",null,n)),i("tr",null,i("th",null,"Filed"),i("td",null,o)),i("tr",null,i("th",null,"Comments"),i("td",null,l)),i("tr",null,i("th",null,"Pages"),i("td",null,u.toString())))))}))}catch(e){e.message||"Aborted"===e.message||console.log(e),this._abort()}}))}render(){const{_results:e,_types:t}=this;return i("calcite-dialog",{heading:"Survey Search",modal:!0,placement:"top",width:"s"},i("calcite-label",null,i("calcite-input",{clearable:!0,placeholder:"Search surveys by survey number, subdivision name or partition number",afterCreate:this._inputAfterCreate.bind(this)})),i("calcite-label",null,"Survey type",i("calcite-select",{afterCreate:this._selectAfterCreate.bind(this)},t.toArray())),i("calcite-list",null,e.toArray()),i("calcite-button",{slot:"footer-end",onclick:this._close.bind(this)},"Close"))}_inputAfterCreate(e){this._input=e,e.addEventListener("calciteInputInput",this._search.bind(this))}_selectAfterCreate(e){this._select=e}};n=t([r("cov.components.SurveySearchDialog")],n);export default n;