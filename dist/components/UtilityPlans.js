/* His name was Bruce McNair. Copyright 2025 City of Vernonia, Oregon. */
import{__awaiter as t,__decorate as e}from"tslib";import{whenOnce as i,watch as o}from"@arcgis/core/core/reactiveUtils";import{property as s,subclass as l}from"@arcgis/core/core/accessorSupport/decorators";import r from"@arcgis/core/widgets/Widget";import{tsx as n}from"@arcgis/core/widgets/support/widget";import a from"@arcgis/core/core/Collection";import{byName as c}from"@arcgis/core/smartMapping/symbology/support/colorRamps";import d from"@arcgis/core/renderers/UniqueValueRenderer";import h from"@arcgis/core/symbols/SimpleFillSymbol";const u="0 = 1";let p=[];const m="view-click-handle";let f=0,y=class extends r{constructor(t){var e;super(t),this._loading=!0,this._listItems=new a,this._locationListItems=new a,this._state="plans-list";const i=null===(e=c("Blue and Red 16"))||void 0===e?void 0:e.colorsForClassBreaks;p=i[(null==i?void 0:i.length)-1].colors.map(t=>t)}postInitialize(){return t(this,void 0,void 0,function*(){const{layer:e,_listItems:s}=this;e.popupEnabled=!1,this.addHandles(o(()=>this.visible,t=>{t?(e.definitionExpression=u,e.visible=!0):(e.visible=!1,this._clear(!0))})),i(()=>this.visible).then(()=>t(this,void 0,void 0,function*(){var t;const i=[],o=[],l=[];try{(yield e.queryFeatures({where:"1 = 1",outFields:["*"],orderByFields:["year DESC"]})).features.forEach(t=>{const e=t.attributes.title;-1===i.indexOf(e)&&(s.add(this._listItem(t)),i.push(e))}),i.forEach(t=>{const i=p[Math.floor(Math.random()*p.length)];l.push({label:t,symbol:new h({color:[0,0,0,0],outline:{color:i,width:1.5}}),value:t});const s=e.labelingInfo[0].clone(),r=s.symbol.clone();r.color=i,s.labelExpressionInfo={expression:"if (IsEmpty($feature.page)) { return $feature.title + ' ' + $feature.year ; } else { return $feature.title + ' ' + $feature.year + TextFormatting.NewLine + 'Page ' + $feature.page; }"},s.symbol=r,s.where=`title = '${t}'`,o.push(s)}),e.renderer=new d({defaultSymbol:null===(t=e.renderer.symbol)||void 0===t?void 0:t.clone(),field:"title",uniqueValueInfos:l}),e.labelingInfo=o,this._loading=!1}catch(t){console.log(t)}}))})}_clear(t){const{layer:e,_list:i,_locationListItems:o}=this;e.definitionExpression=u,i.filterText="",i.selectedItems.forEach(t=>{t.selected=!1}),o.removeAll(),t&&(this.removeHandles(m),this._state="plans-list")}_listItem(t){const{description:e,title:i,url:o,year:s}=t.attributes;return n("calcite-list-item",{description:e,key:f++,label:`${i} - ${s}`,value:t},n("calcite-action",{icon:"file-pdf",slot:"actions-end",text:"View PDF",afterCreate:t=>{t.addEventListener("click",()=>{window.open(o,"_blank")})}}))}_location(){const{view:e}=this;this._clear(),e.closePopup(),this.addHandles(e.on("click",e=>t(this,void 0,void 0,function*(){const{layer:t,_locationListItems:i}=this;e.stopPropagation(),i.removeAll();try{const o=(yield t.queryFeatures({geometry:e.mapPoint,outFields:["*"]})).features;if(!o.length)return void(this._state="location-no-result");const s=[],l=[];o.forEach(t=>{const e=t.attributes.title;-1===s.indexOf(e)&&(i.add(this._listItem(t)),l.push(`title = '${e}'`),s.push(e))}),t.definitionExpression=l.join(" OR "),this._state="location-result"}catch(t){console.log(t)}})),m),this._state="location"}_showListUtilityPlan(e){return t(this,void 0,void 0,function*(){const{layer:t,view:i}=this,o=`title = '${e.attributes.title}'`;t.definitionExpression=o;try{const e=yield t.queryExtent({where:o,returnGeometry:!0});i.goTo(e.extent)}catch(t){console.log(t)}})}_showLocationListUtilityPlan(e){return t(this,void 0,void 0,function*(){const{layer:t,view:i}=this;try{const o=yield t.queryExtent({where:`title = '${e.attributes.title}'`,returnGeometry:!0});i.goTo(o.extent)}catch(t){console.log(t)}})}render(){const{_loading:t,_locationListItems:e,_listItems:i,_state:o}=this;return n("calcite-panel",{heading:"Utility Plans",loading:t},n("calcite-list",{hidden:"plans-list"!==o,"filter-enabled":"","filter-placeholder":"Filter plans by name or type","selection-appearance":"border","selection-mode":"single",afterCreate:this._listAfterCreate.bind(this)},i.toArray(),n("calcite-notice",{kind:"danger",open:!0,slot:"filter-no-results",style:"margin: 0 0.75rem;"},n("div",{slot:"message"},"No results."))),n("calcite-fab",{hidden:"plans-list"!==o,icon:"cursor-click",slot:"plans-list"===o?"fab":null,text:"Query location","text-enabled":"",afterCreate:this._locationFabAfterCreate.bind(this)}),n("calcite-notice",{icon:"cursor-click",open:"location"===o||"location-no-result"===o||"location-result"===o,style:"location"===o||"location-no-result"===o||"location-result"===o?"margin: 0.75rem;":"margin: 0;"},n("div",{slot:"message"},"Click on the map to query utility plans at that location."),n("calcite-link",{slot:"link",afterCreate:this._clearLinkAfterCreate.bind(this)},"Cancel")),n("calcite-notice",{kind:"danger",open:"location-no-result"===o,style:"location-no-result"===o?"margin: 0 0.75rem 0.75rem;":"margin: 0;"},n("div",{slot:"message"},"No utility plans at selected location.")),n("calcite-list",{hidden:"location-result"!==o,"selection-appearance":"border","selection-mode":"single",afterCreate:this._locationListAfterCreate.bind(this)},e.toArray()))}_clearLinkAfterCreate(t){t.addEventListener("click",this._clear.bind(this,!0))}_listAfterCreate(t){const{layer:e}=this;this._list=t,t.filterProps=["description","label"],t.addEventListener("calciteListChange",()=>{const i=t.selectedItems[0];i?this._showListUtilityPlan(i.value):e.definitionExpression=u})}_locationListAfterCreate(t){this._locationList=t,t.addEventListener("calciteListChange",()=>{const e=t.selectedItems[0];e&&this._showLocationListUtilityPlan(e.value)})}_locationFabAfterCreate(t){t.addEventListener("click",this._location.bind(this))}};e([s()],y.prototype,"_loading",void 0),e([s()],y.prototype,"_state",void 0),y=e([l("UtilityPlans")],y);export default y;