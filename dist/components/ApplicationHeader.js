/* His name was Bruce McNair. Copyright 2025 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{watch as r}from"@arcgis/core/core/reactiveUtils";import{property as o,subclass as s}from"@arcgis/core/core/accessorSupport/decorators";import n from"@arcgis/core/widgets/Widget";import{tsx as i}from"@arcgis/core/widgets/support/widget";import a from"@arcgis/core/core/Collection";import c from"./../support/logo";import{referenceElement as l,wrapValuesInHtml as d}from"./support";const u="cov--application-header",h="cov--header-search",p="cov--header-user",_={header:u,headerTitleContainer:`${u}_title-container`,headerTitleLogo:`${u}_title-logo`,headerTitleText:`${u}_title-text`,headerSearchContainer:`${u}_search-container`,headerControlsContainer:`${u}_controls-container`,search:h,searchWrapper:`${h}_wrapper`,searchBar:`${h}_bar`,searchButton:`${h}_button`,searchForm:`${h}_form`,searchInput:`${h}_input`,searchDropdown:`${h}_dropdown`,user:p,userPopover:`${p}_popover`};let g=0,v=class extends n{constructor(e){super(e)}render(){const{title:e}=this;return i("div",{class:_.header,slot:"header"},i("div",{class:_.headerTitleContainer},i("img",{class:_.headerTitleLogo,src:c}),i("div",{class:_.headerTitleText},e)),i("div",{class:_.headerSearchContainer},i("div",{afterCreate:e=>{const{search:t}=this;t&&new f({container:e,search:t})}})),i("div",{class:_.headerControlsContainer},i("div",{afterCreate:e=>{const{oAuth:t}=this;t&&new m({container:e,oAuth:t})}})))}};v=t([s("cov.components.ApplicationHeader")],v);export default v;let f=class extends n{constructor(e){super(e),this._searchAbortController=null,this._sourcesDropdownItems=new a,this._sourcesDropdownOpen=!1,this._suggestions=new a,this._value="";const{search:t}=e;t.includeDefaultSources=!1,t.searchAllEnabled=!1}postInitialize(){return e(this,void 0,void 0,(function*(){const{_sources:e}=this;this._addSources(e),this.addHandles(e.on("change",this._addSources.bind(this,e))),this.addHandles(r((()=>this._value),(e=>{e&&this._search(e)})))}))}_addSources(e){const{search:t,_activeSource:r,_sourcesDropdownItems:o}=this;o.removeAll(),e.forEach(((e,s)=>{const{name:n}=e;o.add(i("calcite-dropdown-item",{key:g++,selected:r===e,afterCreate:e=>{e.addEventListener("calciteDropdownItemSelect",(()=>{this._sourcesDropdownOpen=!1,t.activeSourceIndex=s,this._input.focus()}))}},n))}))}_clear(){const{_input:e,_suggestions:t,_view:r}=this;e.value="",t.removeAll(),r&&r.closePopup(),this._value=""}_search(t){return e(this,void 0,void 0,(function*(){const{search:e,_suggestions:r}=this;this._searchAbort(),r.removeAll();const o=new AbortController,{signal:s}=o;this._searchAbortController=o;try{const n=yield e.suggest(t,null,{signal:s});if(this._searchAbortController!==o)return;if(this._searchAbortController=null,!n||!n.numResults)return;r.addMany(n.results[0].results||[])}catch(e){this._searchAbortController=null,"Aborted"!==e.message&&console.log(e)}}))}_searchAbort(){const{_searchAbortController:e}=this;e&&(e.abort(),this._searchAbortController=null)}_selectResult(t){return e(this,void 0,void 0,(function*(){const{search:e,_input:r,_view:o}=this;r.value=t.text||"";try{const r=(yield e.search(t)).results[0];if(!r.results)return;const s=r.results[0].feature;this.emit("selected-result",s),o&&(o.goTo(s.geometry),s.geometry&&"point"===s.geometry.type&&(o.scale=1200),o.openPopup({features:[s]}))}catch(e){console.log(e)}}))}render(){const{_activeSource:e,_suggestions:t,_sources:r,_sourcesDropdownItems:o,_sourcesDropdownOpen:s,_value:n}=this;return e?i("div",{class:_.search},i("div",{class:_.searchWrapper},i("div",{class:_.searchBar},i("calcite-icon",{class:_.searchButton,hidden:!!(r&&r.length<=1),icon:"chevron-down",roll:"button",afterCreate:this._sourcesButtonAfterCreate.bind(this)}),i("form",{class:_.searchForm,afterCreate:this._searchFormAfterCreate.bind(this)},i("input",{class:_.searchInput,placeholder:e.placeholder,type:"text",afterCreate:this._searchInputAfterCreate.bind(this)})),i("calcite-icon",{class:_.searchButton,hidden:!n,icon:"x",roll:"button",afterCreate:this._clearButtonAfterCreate.bind(this)}),i("calcite-icon",{class:_.searchButton,icon:"search",roll:"button"})),i("calcite-dropdown",{class:_.searchDropdown,role:"listbox",open:t.length>0,afterCreate:this._suggestionDropdownAfterCreate.bind(this)},i("calcite-button",{slot:"trigger",style:"display: none"}),i("calcite-dropdown-group",{"selection-mode":"none"},this._renderSuggestions())),i("calcite-dropdown",{class:_.searchDropdown,role:"listbox",open:s,afterCreate:this._sourcesDropdownAfterCreate.bind(this)},i("calcite-button",{slot:"trigger",style:"display: none !important;"}),i("calcite-dropdown-group",null,o.toArray())))):i("div",null)}_renderSuggestions(){const{_suggestions:e,_value:t}=this;return 0===e.length?[]:e.toArray().map((e=>i("calcite-dropdown-item",{key:g++,afterCreate:r=>{r.innerHTML=d(e.text||"",t),r.addEventListener("calciteDropdownItemSelect",this._selectResult.bind(this,e))}})))}_clearButtonAfterCreate(e){e.addEventListener("click",this._clear.bind(this))}_searchFormAfterCreate(e){const{_suggestions:t}=this;e.addEventListener("submit",(e=>{if(e.preventDefault(),t.length){const e=t.getItemAt(0);e&&this._selectResult(e),t.removeAll()}}))}_searchInputAfterCreate(e){this._input=e,e.addEventListener("input",(()=>{const{value:t}=e;this._value=t})),e.addEventListener("keydown",(e=>{var t;const{key:r}=e;if("Escape"!==r&&"ArrowDown"!==r)return;const{_suggestions:o,_suggestionsDropdown:s}=this;"Escape"===r&&this._clear(),"ArrowDown"===r&&o.length&&(null===(t=s.querySelector("calcite-dropdown-item"))||void 0===t||t.setFocus())}))}_sourcesDropdownAfterCreate(e){this._sourcesDropdown=e,e.addEventListener("calciteDropdownClose",(()=>{this._sourcesDropdownOpen=!1}))}_sourcesButtonAfterCreate(e){e.addEventListener("click",(()=>{var e;const{_sourcesDropdown:t}=this;this._clear(),this._sourcesDropdownOpen=!0,null===(e=t.querySelector("calcite-dropdown-item"))||void 0===e||e.setFocus()}))}_suggestionDropdownAfterCreate(e){this._suggestionsDropdown=e}};t([o({aliasOf:"search.activeSource"})],f.prototype,"_activeSource",void 0),t([o({aliasOf:"search.sources"})],f.prototype,"_sources",void 0),t([o()],f.prototype,"_sourcesDropdownOpen",void 0),t([o()],f.prototype,"_suggestions",void 0),t([o()],f.prototype,"_value",void 0),t([o({aliasOf:"search.view"})],f.prototype,"_view",void 0),f=t([s("HeaderSearch")],f);let m=class extends n{constructor(e){super(e)}render(){const{oAuth:e,oAuth:{signedIn:t,fullName:r,username:o,thumbnailUrl:s}}=this;return t?i("div",{class:_.user},i("calcite-avatar",{"full-name":r,thumbnail:s,role:"button"}),i("calcite-popover",{"auto-close":"",label:"Sign out","overlay-positioning":"fixed",afterCreate:l},i("div",{class:_.userPopover},i("div",null,r),i("span",null,o),i("calcite-button",{scale:"small",width:"full",onclick:e.signOut.bind(e)},"Sign out")))):i("div",{class:_.user},i("calcite-icon",{icon:"sign-in",role:"button",onclick:e.signIn.bind(e)}),i("calcite-tooltip",{label:"Sign in","overlay-positioning":"fixed",afterCreate:l},"Sign in"))}};m=t([s("HeaderUser")],m);