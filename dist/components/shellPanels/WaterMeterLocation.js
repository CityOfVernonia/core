/* His name was Bruce McNair. Copyright 2024 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{subclass as r,property as i}from"@arcgis/core/core/accessorSupport/decorators";import s from"@arcgis/core/widgets/Widget";import{tsx as o}from"@arcgis/core/widgets/support/widget";import l from"@arcgis/core/core/Collection";import a from"@arcgis/core/widgets/Search/SearchViewModel";import c from"@arcgis/core/widgets/Search/LayerSearchSource";import n from"@arcgis/core/widgets/Print/PrintViewModel";import d from"@arcgis/core/rest/support/PrintTemplate";let u=0,h=class extends s{constructor(e){super(e),this._feature=null,this._printViewModel=new n,this._searchAbortController=null,this._searchResults=new l,this._searchViewModel=new a({includeDefaultSources:!1})}postInitialize(){return e(this,void 0,void 0,(function*(){const{layer:e,view:t,_searchViewModel:r}=this;r.sources.add(new c({layer:e,searchFields:["wsc_id","address"],outFields:["*"],maxSuggestions:6,suggestionTemplate:"{wsc_id} - {address}"})),this.addHandles(this.watch("_feature",(r=>{const i=e.objectIdField;e.definitionExpression=r?`${i} = ${r.attributes[i]}`:"",r?this._clickHandle.remove():t.on("click",this._clickEvent.bind(this))}))),this._layerView=yield t.whenLayerView(e),this._clickHandle=t.on("click",this._clickEvent.bind(this)),console.log(this)}))}_print(){return e(this,void 0,void 0,(function*(){const{_feature:e,_printViewModel:t}=this;if(e){this.container.querySelector("calcite-panel[data-feature-panel]").loading=!0;try{const r=yield t.print(new d({format:"pdf",layout:"letter-ansi-a-landscape",layoutOptions:{titleText:e.attributes.Address}}));window.open(r.url,"_blank"),this._feature=null}catch(e){console.log(e),this._feature=null}}}))}_search(t){return e(this,void 0,void 0,(function*(){const{_searchViewModel:e,_searchResults:r}=this,i=t.target.value;if(this._searchAbort(),r.removeAll(),!i)return;const s=new AbortController,{signal:l}=s;this._searchAbortController=s;try{const t=yield e.suggest(i,null,{signal:l});if(this._searchAbortController!==s)return;if(this._searchAbortController=null,!t.numResults)return;t.results[t.activeSourceIndex].results.forEach((e=>{r.add(o("calcite-list-item",{key:u++,label:e.text,onclick:this._selectSuggestFeature.bind(this,e)}))}))}catch(e){this._searchAbortController=null,"Aborted"!==e.message&&console.log("water meter query error",e)}}))}_searchAbort(){const{_searchAbortController:e}=this;e&&(e.abort(),this._searchAbortController=null)}_selectSuggestFeature(t){return e(this,void 0,void 0,(function*(){const{_searchViewModel:e}=this;try{const r=(yield e.search(t)).results[0].results[0].feature;this._selectFeature(r)}catch(e){console.log(e)}}))}_selectFeature(e){const{view:t}=this;this._feature=e,t.goTo(e.geometry),t.scale=600}_clearFeature(){console.log("clear"),this._feature=null}_clickEvent(t){return e(this,void 0,void 0,(function*(){const{view:e,_layerView:r}=this,{mapPoint:i,stopPropagation:s}=t;s();const o=(yield r.queryFeatures({geometry:i,outFields:["*"],distance:3*e.resolution,returnGeometry:!0})).features[0];o&&this._selectFeature(o)}))}render(){const{_feature:e,_searchResults:t}=this;return o("calcite-shell-panel",null,o("calcite-panel",{hidden:null!==e},o("calcite-notice",{icon:"cursor-click",open:"",style:"padding:0.75rem;"},o("div",{slot:"message"},"Click or search to select a water meter")),o("calcite-input",{placeholder:"Search service id or address",clearable:"",style:"padding:0 0.75rem 0.75rem 0.75rem;",afterCreate:e=>{e.addEventListener("calciteInputInput",this._search.bind(this))}}),o("calcite-list",null,t.toArray())),this._renderFeature())}_renderFeature(){const{_feature:e}=this;if(!e)return null;const{wsc_id:t,Address:r}=e.attributes;return o("calcite-panel",{"data-feature-panel":""},o("div",{style:"padding:0.75rem;"},o("calcite-notice",{icon:"information",open:"",style:"width:100%;"},o("div",{slot:"title"},t),o("div",{slot:"message"},r))),o("calcite-button",{appearance:"outline",slot:"footer",width:"half",afterCreate:e=>{e.addEventListener("click",this._clearFeature.bind(this))}},"Clear"),o("calcite-button",{slot:"footer",width:"half",afterCreate:e=>{e.addEventListener("click",this._print.bind(this))}},"Print"))}};t([i({aliasOf:"_printViewModel.printServiceUrl"})],h.prototype,"printServiceUrl",void 0),t([i({aliasOf:"_printViewModel.view"})],h.prototype,"view",void 0),t([i()],h.prototype,"_feature",void 0),h=t([r("cov.shellPanels.WaterMetersLocation")],h);export default h;