/* His name was Bruce McNair. Copyright 2024 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{subclass as r,property as i}from"@arcgis/core/core/accessorSupport/decorators";import s from"@arcgis/core/widgets/Widget";import{tsx as l}from"@arcgis/core/widgets/support/widget";import o from"@arcgis/core/core/Collection";import a from"@arcgis/core/widgets/Search/SearchViewModel";import c from"@arcgis/core/widgets/Search/LayerSearchSource";import n from"@arcgis/core/widgets/Print/PrintViewModel";import d from"@arcgis/core/rest/support/PrintTemplate";const h="cov-shell-panels--water-meters_content",p="cov-shell-panels--water-meters_print-buttons",u="cov-shell-panels--water-meters_search-input";let g=0,m=0,w=class extends s{constructor(e){super(e),this._printResults=new o,this._printViewModel=new n,this._searchAbortController=null,this._searchResults=new o,this._searchViewModel=new a({includeDefaultSources:!1}),this._viewState="search"}postInitialize(){const{layer:e,_searchViewModel:t}=this;t.sources.add(new c({layer:e,searchFields:["wsc_id","address"],outFields:["*"],maxSuggestions:6,suggestionTemplate:"{wsc_id} - {address}"}))}_changeLabels(e){const{layer:t}=this,r=e.target.value,i=t.labelingInfo[0];t.labelsVisible=!!r,r&&(i.labelExpressionInfo.expression=`$feature.${r}`)}_print(){const{_printResults:t,_printViewModel:r}=this;t.add(l("calcite-button",{key:g++,appearance:"outline-fill",disabled:"",loading:"",width:"full",afterCreate:t=>e(this,void 0,void 0,(function*(){try{const e=yield r.print(new d({format:"pdf",layout:"letter-ansi-a-landscape",layoutOptions:{titleText:"Water Meters"}}));t.innerText=`Map Print (${++m})`,t.disabled=!1,t.loading=!1,t.addEventListener("click",(()=>{window.open(e.url,"_blank")}))}catch(e){console.log(e),t.loading=!1,t.kind="danger",t.iconStart="exclamation-mark-triangle",t.innerText="Print error"}}))},"Printing"))}_search(t){return e(this,void 0,void 0,(function*(){const{_searchViewModel:e,_searchResults:r}=this,i=t.target.value;if(this._searchAbort(),r.removeAll(),!i)return;const s=new AbortController,{signal:o}=s;this._searchAbortController=s;try{const t=yield e.suggest(i,null,{signal:o});if(this._searchAbortController!==s)return;if(this._searchAbortController=null,!t.numResults)return;t.results[t.activeSourceIndex].results.forEach((e=>{r.add(l("calcite-list-item",{key:g++,label:e.text,onclick:this._selectFeature.bind(this,e)}))}))}catch(e){this._searchAbortController=null,"Aborted"!==e.message&&console.log("water meter query error",e)}}))}_searchAbort(){const{_searchAbortController:e}=this;e&&(e.abort(),this._searchAbortController=null)}_selectFeature(t){return e(this,void 0,void 0,(function*(){const{view:e,view:{popup:r},_searchViewModel:i}=this;try{const s=(yield i.search(t)).results[0].results[0].feature;r.open({features:[s]}),e.goTo(s.geometry),e.scale=1200}catch(e){console.log(e)}}))}render(){const{_printResults:e,_searchResults:t,_viewState:r}=this;return l("calcite-shell-panel",null,l("calcite-panel",{heading:"Water Meters"},l("calcite-action",{active:"print"===this._viewState,icon:"print",slot:"header-actions-end",text:"Print",onclick:()=>{this._viewState="print"===r?"search":"print"}},l("calcite-tooltip",{"close-on-click":"",label:"Print",placement:"bottom",slot:"tooltip"},"Print")),l("calcite-action",{active:"labels"===this._viewState,icon:"label",slot:"header-actions-end",text:"Labels",onclick:()=>{this._viewState="labels"===r?"search":"labels"}},l("calcite-tooltip",{"close-on-click":"",label:"Labels",placement:"bottom",slot:"tooltip"},"Labels")),l("div",{hidden:"search"!==r},l("calcite-input",{class:u,placeholder:"Search service id or address",clearable:"",afterCreate:e=>{e.addEventListener("calciteInputInput",this._search.bind(this))}}),l("calcite-list",null,t.toArray())),l("div",{class:h,hidden:"print"!==r},l("calcite-notice",{icon:"print",open:""},l("div",{slot:"message"},"Position the map to the area you wish to print."),l("calcite-link",{slot:"link",onclick:this._print.bind(this)},"Print map")),e.length?l("div",{class:p},e.toArray()):null),l("div",{class:h,hidden:"labels"!==r},l("calcite-label",null,"Water meter labels",l("calcite-segmented-control",{afterCreate:e=>{e.addEventListener("calciteSegmentedControlChange",this._changeLabels.bind(this))}},l("calcite-segmented-control-item",{value:""},"None"),l("calcite-segmented-control-item",{checked:"",value:"wsc_id"},"Service id"),l("calcite-segmented-control-item",{value:"address"},"Address")))),l("calcite-button",{appearance:"outline",hidden:"search"===r,slot:"search"!==r?"footer":null,width:"full",onclick:()=>{this._viewState="search"}},"Back")))}};t([i({aliasOf:"_printViewModel.printServiceUrl"})],w.prototype,"printServiceUrl",void 0),t([i({aliasOf:"_printViewModel.view"})],w.prototype,"view",void 0),t([i()],w.prototype,"_viewState",void 0),w=t([r("cov.shellPanels.WaterMeters")],w);export default w;