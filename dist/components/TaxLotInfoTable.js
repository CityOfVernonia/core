/* His name was Bruce McNair. Copyright 2025 City of Vernonia, Oregon. */
import{__awaiter as t,__decorate as l}from"tslib";import{property as e,subclass as n}from"@arcgis/core/core/accessorSupport/decorators";import o from"@arcgis/core/widgets/Widget";import{tsx as r}from"@arcgis/core/widgets/support/widget";import{referenceElement as i}from"./../components/support";import{propertyInfoUrl as a,taxMapUrl as s}from"./../support/taxLotUtils";import{load as d,isLoaded as u,execute as c}from"@arcgis/core/geometry/operators/geodesicBufferOperator";let h=0;const f="--calcite-loader-progress-color-inline: var(--calcite-color-brand);",g="max-width: 165px; padding: 0.25rem; ";let p=class extends o{constructor(t){super(t),this._flood=r("tr",null,r("th",null,"Flood zones"),r("td",{style:f},r("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"}))),this._mailing=r("tr",null,r("th",null,"Mailing address"),r("td",{style:f},r("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"}))),this._wetlands=r("tr",null,r("th",null,"Wetlands"),r("td",{style:f},r("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"}))),this._zoning=r("tr",null,r("th",null,"Zoning"),r("td",{style:f},r("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"})))}postInitialize(){return t(this,void 0,void 0,(function*(){const{graphic:{geometry:t,attributes:{VERNONIA:l}}}=this;if(this._mailingInfo(),!t||0===l)return;u()||(yield d());const e=c(t,-1,{unit:"feet"});this._zoningInfo(e),this._floodInfo(e),this._wetlandInfo(e)}))}_floodInfo(l){return t(this,void 0,void 0,(function*(){const{infoLayers:t}=this;if(!t)return;const{flood:e}=t;try{const t=yield e.queryFeatures({geometry:l,outFields:["flood_zone"],returnGeometry:!1}),n=[];t.features.forEach((t=>{const{flood_zone:l}=t.attributes;-1===n.indexOf(l)&&n.push(l)})),this._flood=n.length?r("tr",null,r("th",null,r("calcite-link",{"icon-end":"information"},"Flood zones"),r("calcite-popover",{"auto-close":"",closable:!0,scale:"s",afterCreate:i},r("div",{style:g},"Some portion of the tax lot is affected by the indicated flood zones. Turn on flood hazard layer to view flood zones."))),r("td",null,n.map((t=>r("div",{key:h++},t))))):r("tr",null,r("th",null,"Flood zones"),r("td",null,"None"))}catch(t){console.log(t),this._flood=r("tr",null,r("th",null,"Flood zones"),r("td",null,"An error occurred"))}}))}_mailingInfo(){return t(this,void 0,void 0,(function*(){var t;const{graphic:l}=this;try{const e=l.layer,n=l.attributes[e.objectIdField],o=null===(t=(yield e.queryRelatedFeatures({objectIds:[n],outFields:["M_ADDRESS","M_CITY","M_STATE","M_ZIP"],relationshipId:0}))[n])||void 0===t?void 0:t.features[0];if(!o)return void(this._mailing=r("tr",null,r("th",null,"Mailing address"),r("td",null,"Unknown")));const{M_ADDRESS:i,M_CITY:a,M_STATE:s,M_ZIP:d}=o.attributes;this._mailing=r("tr",null,r("th",null,"Mailing address"),r("td",null,i,r("br",null),a,", ",s," ",d))}catch(t){console.log(t),this._mailing=r("tr",null,r("th",null,"Mailing address"),r("td",null,"An error occurred"))}}))}_wetlandInfo(l){return t(this,void 0,void 0,(function*(){const{infoLayers:t}=this;if(!t)return;const{wetlands:{lwi:e,nwi:n,mow:o}}=t;try{const t=(yield e.queryFeatures({geometry:l,returnGeometry:!1})).features.length,a=(yield n.queryFeatures({geometry:l,returnGeometry:!1})).features.length,s=(yield o.queryFeatures({geometry:l,returnGeometry:!1})).features.length;this._wetlands=t+a+s>0?r("tr",null,r("th",null,r("calcite-link",{"icon-end":"information"},"Wetlands"),r("calcite-popover",{"auto-close":"",closable:!0,scale:"s",afterCreate:i},r("div",{style:g},"Some portion of the tax lot may be affected by wetlands. Turn on wetlands layer to view potential wetlands."))),r("td",null,"Yes")):r("tr",null,r("th",null,"Wetlands"),r("td",null,"No"))}catch(t){console.log(t),this._wetlands=r("tr",null,r("th",null,"Wetlands"),r("td",null,"An error occurred"))}}))}_zoningInfo(l){return t(this,void 0,void 0,(function*(){const{infoLayers:t}=this;if(!t)return;const{zoning:e}=t;try{const t=yield e.queryFeatures({geometry:l,outFields:["localZCode","localZDesc"],returnGeometry:!1}),n=[];t.features.forEach((t=>{const{localZCode:l,localZDesc:e}=t.attributes,o=`${l} - ${e}`;-1===n.indexOf(o)&&n.push(o)})),this._zoning=r("tr",null,r("th",null,"Zoning"),r("td",null,n.map((t=>r("div",{key:h++},t)))))}catch(t){console.log(t),this._zoning=r("tr",null,r("th",null,"Zoning"),r("td",null,"An error occurred"))}}))}render(){const{infoLayers:t,_flood:l,_mailing:e,_wetlands:n,_zoning:o}=this,{VERNONIA:i}=this.graphic.attributes;return r("table",{class:"cov--feature-table"},this._renderTaxLotInfo(),e,t&&1===i?o:null,t&&1===i?l:null,t&&1===i?n:null)}_renderTaxLotInfo(){const{TAXLOT_ID:t,ACCELA_MT:l,ACCOUNT_IDS:e,TAXMAP:n,ADDRESS:o,OWNER:i,ACRES:d,SQ_FEET:u}=this.graphic.attributes,c=o?r("tr",null,r("th",null,"Address"),r("td",null,o)):null;let h="Unknown",f=[];return e&&(f=e.includes(",")?e.split(","):e.split("||"),h=1===f.length?r("calcite-link",{href:`${a(f[0])}`,target:"_blank"},f[0]):f.map(((t,l)=>r("span",null,r("calcite-link",{href:`${a(t)}`,target:"_blank"},t),l<f.length-1?r("span",null,"  "):"")))),[r("tr",null,r("th",null,"Tax lot"),r("td",null,r("calcite-link",{href:`https://vernonia-tax-lot.netlify.app/${t}/`,target:"_blank"},t))),r("tr",null,r("th",null,"Accela id"),r("td",null,this._renderAccela(l))),r("tr",null,r("th",null,"Tax map"),r("td",null,r("calcite-link",{href:`${s(n)}`,target:"_blank"},n))),r("tr",null,r("th",null,"Owner"),r("td",null,i||"Unknown")),c,r("tr",null,r("th",null,"Area"),r("td",null,d," acres  ",u.toLocaleString()," sq ft")),r("tr",null,r("th",null,"Tax account",f.length>1?"s":""),r("td",null,h))]}_renderAccela(t){const{accelaParcelURLTemplate:l}=this;return l?r("calcite-link",{href:l.replace("{id}",t),target:"_blank"},t):t}};l([e()],p.prototype,"_flood",void 0),l([e()],p.prototype,"_mailing",void 0),l([e()],p.prototype,"_wetlands",void 0),l([e()],p.prototype,"_zoning",void 0),p=l([n("cov.components.TaxLotInfoTable")],p);export default p;