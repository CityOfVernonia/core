/* His name was Bruce McNair. Copyright 2025 City of Vernonia, Oregon. */
import{__awaiter as t,__decorate as l}from"tslib";import e from"@arcgis/core/identity/IdentityManager";import n from"@arcgis/core/portal/Portal";import{property as o,subclass as r}from"@arcgis/core/core/accessorSupport/decorators";import i from"@arcgis/core/widgets/Widget";import{tsx as a}from"@arcgis/core/widgets/support/widget";import{referenceElement as s}from"./../components/support";import{propertyInfoUrl as d,taxMapUrl as u,accelaUrl as c,ePermittingUrl as h}from"./../support/taxLotUtils";import{load as f,isLoaded as g,execute as p}from"@arcgis/core/geometry/operators/geodesicBufferOperator";let y=0;const _="--calcite-loader-progress-color-inline: var(--calcite-color-brand);",m="max-width: 165px; padding: 0.25rem; ";let v=class extends i{constructor(t){super(t),this._authed=!1,this._flood=a("tr",null,a("th",null,"Flood zones"),a("td",{style:_},a("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"}))),this._mailing=a("tr",null,a("th",null,"Mailing address"),a("td",{style:_},a("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"}))),this._wetlands=a("tr",null,a("th",null,"Wetlands"),a("td",{style:_},a("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"}))),this._zoning=a("tr",null,a("th",null,"Zoning"),a("td",{style:_},a("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"})))}postInitialize(){return t(this,void 0,void 0,(function*(){const{graphic:{geometry:t,attributes:{VERNONIA:l}}}=this;if(this._mailingInfo(),!t||0===l)return;e.checkSignInStatus((new n).url).then((()=>{this._authed=!0})),g()||(yield f());const o=p(t,-1,{unit:"feet"});this._zoningInfo(o),this._floodInfo(o),this._wetlandInfo(o)}))}_floodInfo(l){return t(this,void 0,void 0,(function*(){const{infoLayers:t}=this;if(!t)return;const{flood:e}=t;try{const t=yield e.queryFeatures({geometry:l,outFields:["flood_zone"],returnGeometry:!1}),n=[];t.features.forEach((t=>{const{flood_zone:l}=t.attributes;-1===n.indexOf(l)&&n.push(l)})),this._flood=n.length?a("tr",null,a("th",null,a("calcite-link",{"icon-end":"information"},"Flood zones"),a("calcite-popover",{"auto-close":"",closable:!0,scale:"s",afterCreate:s},a("div",{style:m},"Some portion of the tax lot is affected by the indicated flood zones. Turn on flood hazard layer to view flood zones."))),a("td",null,n.map((t=>a("div",{key:y++},t))))):a("tr",null,a("th",null,"Flood zones"),a("td",null,"None"))}catch(t){console.log(t),this._flood=a("tr",null,a("th",null,"Flood zones"),a("td",null,"An error occurred"))}}))}_mailingInfo(){return t(this,void 0,void 0,(function*(){var t;const{graphic:l}=this;try{const e=l.layer,n=l.attributes[e.objectIdField],o=null===(t=(yield e.queryRelatedFeatures({objectIds:[n],outFields:["M_ADDRESS","M_CITY","M_STATE","M_ZIP"],relationshipId:0}))[n])||void 0===t?void 0:t.features[0];if(!o)return void(this._mailing=a("tr",null,a("th",null,"Mailing address"),a("td",null,"Unknown")));const{M_ADDRESS:r,M_CITY:i,M_STATE:s,M_ZIP:d}=o.attributes;this._mailing=a("tr",null,a("th",null,"Mailing address"),a("td",null,r,a("br",null),i,", ",s," ",d))}catch(t){console.log(t),this._mailing=a("tr",null,a("th",null,"Mailing address"),a("td",null,"An error occurred"))}}))}_wetlandInfo(l){return t(this,void 0,void 0,(function*(){const{infoLayers:t}=this;if(!t)return;const{wetlands:{lwi:e,nwi:n,mow:o}}=t;try{const t=(yield e.queryFeatures({geometry:l,returnGeometry:!1})).features.length,r=(yield n.queryFeatures({geometry:l,returnGeometry:!1})).features.length,i=(yield o.queryFeatures({geometry:l,returnGeometry:!1})).features.length;this._wetlands=t+r+i>0?a("tr",null,a("th",null,a("calcite-link",{"icon-end":"information"},"Wetlands"),a("calcite-popover",{"auto-close":"",closable:!0,scale:"s",afterCreate:s},a("div",{style:m},"Some portion of the tax lot may be affected by wetlands. Turn on wetlands layer to view potential wetlands."))),a("td",null,"Yes")):a("tr",null,a("th",null,"Wetlands"),a("td",null,"No"))}catch(t){console.log(t),this._wetlands=a("tr",null,a("th",null,"Wetlands"),a("td",null,"An error occurred"))}}))}_zoningInfo(l){return t(this,void 0,void 0,(function*(){const{infoLayers:t}=this;if(!t)return;const{zoning:e}=t;try{const t=yield e.queryFeatures({geometry:l,outFields:["localZCode","localZDesc"],returnGeometry:!1}),n=[];t.features.forEach((t=>{const{localZCode:l,localZDesc:e}=t.attributes,o=`${l} - ${e}`;-1===n.indexOf(o)&&n.push(o)})),this._zoning=a("tr",null,a("th",null,"Zoning"),a("td",null,n.map((t=>a("div",{key:y++},t)))))}catch(t){console.log(t),this._zoning=a("tr",null,a("th",null,"Zoning"),a("td",null,"An error occurred"))}}))}render(){const{infoLayers:t,_flood:l,_mailing:e,_wetlands:n,_zoning:o}=this,{VERNONIA:r}=this.graphic.attributes;return a("table",{class:"cov--feature-table"},this._renderTaxLotInfo(),e,t&&1===r?o:null,t&&1===r?l:null,t&&1===r?n:null)}_renderTaxLotInfo(){const{_authed:t}=this,{TAXLOT_ID:l,ACCELA_MT:e,ACCOUNT_IDS:n,TAXMAP:o,ADDRESS:r,OWNER:i,ACRES:s,SQ_FEET:f,VERNONIA:g}=this.graphic.attributes;let p=null;1===g&&t?p=a("tr",null,a("th",null,"Accela"),a("td",null,a("calcite-link",{href:c(e),target:"_blank"},e))):1!==g||t||(p=a("tr",null,a("th",null,"ePermitting"),a("td",null,a("calcite-link",{href:h(),target:"_blank"},e))));const y=r?a("tr",null,a("th",null,"Address"),a("td",null,r)):null;let _="Unknown",m=[];return n&&(m=n.includes(",")?n.split(","):n.split("||"),_=1===m.length?a("calcite-link",{href:`${d(m[0])}`,target:"_blank"},m[0]):m.map(((t,l)=>a("span",null,a("calcite-link",{href:`${d(t)}`,target:"_blank"},t),l<m.length-1?a("span",null,"  "):"")))),[a("tr",null,a("th",null,"Tax lot"),a("td",null,a("calcite-link",{href:`https://vernonia-tax-lot.netlify.app/${l}/`,target:"_blank"},l))),p,a("tr",null,a("th",null,"Tax map"),a("td",null,a("calcite-link",{href:`${u(o)}`,target:"_blank"},o))),a("tr",null,a("th",null,"Owner"),a("td",null,i||"Unknown")),y,a("tr",null,a("th",null,"Area"),a("td",null,s," acres  ",f.toLocaleString()," sq ft")),a("tr",null,a("th",null,"Tax account",m.length>1?"s":""),a("td",null,_))]}};l([o()],v.prototype,"_authed",void 0),l([o()],v.prototype,"_flood",void 0),l([o()],v.prototype,"_mailing",void 0),l([o()],v.prototype,"_wetlands",void 0),l([o()],v.prototype,"_zoning",void 0),v=l([r("cov.components.TaxLotInfoTable")],v);export default v;