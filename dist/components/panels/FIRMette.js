/* His name was Bruce McNair. Copyright 2024 City of Vernonia, Oregon. */
import{__awaiter as t,__decorate as e}from"tslib";import i from"@arcgis/core/request";import{subclass as o,property as r}from"@arcgis/core/core/accessorSupport/decorators";import s from"@arcgis/core/widgets/Widget";import{tsx as n}from"@arcgis/core/widgets/support/widget";import{Point as c}from"@arcgis/core/geometry";import l from"@arcgis/core/Graphic";import{SimpleMarkerSymbol as a}from"@arcgis/core/symbols";const p="margin: 0.5rem 0.75rem",d="https://msc.fema.gov/arcgis/rest/services/NFHL_Print/AGOLPrintB/GPServer/Print%20FIRM%20or%20FIRMette/";let h=class extends s{constructor(t){super(t),this._firmetteURL="",this._graphic=new l({symbol:new a({style:"x",outline:{color:[255,0,0],width:2},size:12}),visible:!1}),this._point=new c,this._viewState="ready"}postInitialize(){const{view:{graphics:t},_graphic:e}=this;t.add(e),this.addHandles(this.watch("visible",(t=>{const{view:e,_viewClickHandle:i,_viewState:o}=this;t?(e.closePopup(),this._viewClickHandle=e.on("click",this._viewClickEvent.bind(this)),this.addHandles(this._viewClickHandle),"ready"!==o&&"error"!==o&&this._graphicVisible(!0)):(i&&i.remove(),this._graphicVisible(!1))})))}_error(){this._graphicVisible(!1),this._viewState="error"}_graphicVisible(t){this._graphic.visible=t}_print(){return t(this,void 0,void 0,(function*(){const{_point:{x:t,y:e}}=this;this._viewState="printing";try{const o=yield i(`${d}submitJob`,{responseType:"json",query:{f:"json",FC:JSON.stringify({geometryType:"esriGeometryPoint",features:[{geometry:{x:t,y:e,spatialReference:{wkid:102100}}}],sr:{wkid:102100}}),Print_Type:"FIRMETTE",graphic:"PDF",input_lat:29.877,input_lon:-81.2837}});this._printCheck(o)}catch(t){console.log(t),this._error()}}))}_printCheck(e){return t(this,void 0,void 0,(function*(){const{data:{jobId:t,jobStatus:o}}=e;if("esriJobSubmitted"===o||"esriJobExecuting"===o)try{const e=yield i(`${d}jobs/${t}`,{responseType:"json",query:{f:"json"}});setTimeout(this._printCheck.bind(this,e),1500)}catch(t){console.log(t),this._error()}else"esriJobSucceeded"===o?this._printComplete(e):(console.log("server job error",e),this._error())}))}_printComplete(e){return t(this,void 0,void 0,(function*(){const{data:{jobId:t,results:{OutputFile:{paramUrl:o}}}}=e;try{const e=yield i(`${d}jobs/${t}/${o}`,{responseType:"json",query:{f:"json"}});this._firmetteURL=e.data.value.url.replace("http://","https://"),this._viewState="printed"}catch(t){console.log(t),this._error()}}))}_reset(){this._graphicVisible(!1),this._viewState="ready"}_viewClickEvent(t){const{_graphic:e}=this,{mapPoint:i,stopPropagation:o}=t;o(),this._point=e.geometry=i,this._graphicVisible(!0),this._viewState="map-point"}render(){const{_firmetteURL:t,_point:{latitude:e,longitude:i},_viewState:o}=this;return n("calcite-panel",{heading:"FIRMette"},n("calcite-notice",{hidden:"ready"!==o,icon:"cursor-click",style:p,open:""},n("div",{slot:"message"},"Click on the map at the location to print a FIRMette.")),n("calcite-notice",{hidden:"map-point"!==o,icon:"pin",style:p,open:""},n("div",{slot:"message"},n("div",null,"Latitude: ",e.toFixed(4)),n("div",null,"Longitude: ",i.toFixed(4)))),n("calcite-button",{appearance:"outline",hidden:"map-point"!==o,slot:"map-point"===o?"footer":null,width:"full",onclick:this._reset.bind(this)},"Cancel"),n("calcite-button",{hidden:"map-point"!==o,slot:"map-point"===o?"footer":null,width:"full",onclick:this._print.bind(this)},"Print"),n("calcite-loader",{hidden:"printing"!==o,scale:"s",text:"Printing FIRMette",type:"indeterminate"}),n("calcite-notice",{hidden:"printed"!==o,icon:"check",style:p,open:""},n("div",{slot:"message"},"Your FIRMette is ready.")),n("calcite-button",{appearance:"outline",hidden:"printed"!==o,slot:"printed"===o?"footer":null,width:"full",onclick:this._reset.bind(this)},"Reset"),n("calcite-button",{hidden:"printed"!==o,slot:"printed"===o?"footer":null,width:"full",onclick:()=>{window.open(t,"_blank")}},"View"),n("calcite-notice",{hidden:"error"!==o,icon:"exclamation-mark-circle",kind:"danger",style:p,open:""},n("div",{slot:"message"},"An error has occurred.")),n("calcite-button",{appearance:"outline",hidden:"error"!==o,slot:"error"===o?"footer":null,width:"full",onclick:this._reset.bind(this)},"Try Again"))}};e([r()],h.prototype,"_firmetteURL",void 0),e([r()],h.prototype,"_point",void 0),e([r()],h.prototype,"_viewState",void 0),h=e([o("cov.panels.FIRMette")],h);export default h;