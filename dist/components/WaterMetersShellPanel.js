/* His name was Bruce McNair. Copyright 2025 City of Vernonia, Oregon. */
import{__awaiter as t,__decorate as e}from"tslib";import{property as i,subclass as s}from"@arcgis/core/core/accessorSupport/decorators";import r from"@arcgis/core/widgets/Widget";import{tsx as l}from"@arcgis/core/widgets/support/widget";import o from"@arcgis/core/core/Collection";import n from"@arcgis/core/widgets/Search/SearchViewModel";import a from"@arcgis/core/widgets/Search/LayerSearchSource";const c="esri-widget__table",d="click",u="highlight";let h=0;const _="--calcite-dialog-content-space: 0; --calcite-dialog-min-size-y: 0;",g="margin: 0.75rem;",f="--calcite-panel-background-color: var(--calcite-color-foreground-1);";let m=class extends r{constructor(t){super(t),this._controller=null,this._data={},this._dialog=new p,this._feature=null,this._results=new o,this._state="search"}postInitialize(){return t(this,void 0,void 0,function*(){const{layer:t,view:e}=this;this._svm=new n({includeDefaultSources:!1,sources:[new a({layer:t,searchFields:["wsc_id","address"],outFields:["*"],maxSuggestions:6,suggestionTemplate:"{wsc_id} - {address}"})]});try{this._layerView=yield e.whenLayerView(t),this.addHandles(e.on("click",this._click.bind(this)),d)}catch(t){console.log(t)}})}_abort(){const{_controller:t}=this;t&&(t.abort(),this._controller=null)}_clear(){this._state="search",this._feature=null,this._data={},this.removeHandles(u)}_click(e){return t(this,void 0,void 0,function*(){const{_dialog:t,_layerView:i}=this,{mapPoint:s}=e;try{const e=yield i.queryFeatures({geometry:s,outFields:["*"],distance:5});if(e.features.length>1)return t.items.removeAll(),e.features.forEach(e=>{const{Address:i,wsc_id:s}=e.attributes;t.items.add(l("calcite-list-item",{key:h++,label:`${s} - ${i}`,onclick:()=>{this._select(e),t.container.open=!1}}))}),void(t.container.open=!0);const r=e.features[0];if(!r)return;this._select(r)}catch(t){this._clear(),console.log(t)}})}_info(e){return t(this,void 0,void 0,function*(){const{layer:t}=this,i=e.attributes[t.objectIdField];try{const e=yield t.queryRelatedFeatures({relationshipId:0,outFields:["*"],objectIds:[i]});this._data=e[i].features[0].attributes,this._state="info"}catch(t){console.log(t),this._state="info"}})}_search(e){return t(this,void 0,void 0,function*(){var t;const{_svm:i}=this;try{const s=null===(t=yield i.search(e))||void 0===t?void 0:t.results;if(!s||!s[0].results||!s[0].results.length)return;const r=s[0].results[0].feature;this._select(r,!0)}catch(t){console.log(t),this._clear()}})}_select(t,e){const{view:i,_layerView:s}=this;this._feature=t,this._info(t),this.removeHandles(u),this.addHandles(s.highlight(t),u),!0===e&&(i.goTo(t),i.scale=1200)}_suggest(e){return t(this,void 0,void 0,function*(){var t;const{_results:i,_svm:s}=this,r=e.target.value;if(this._abort(),i.removeAll(),!r)return;const o=new AbortController,{signal:n}=o;this._controller=o;try{const e=yield s.suggest(r,null,{signal:n});if(this._controller!==o)return;if(this._controller=null,!e||!e.results||!e.numResults)return;null===(t=e.results[e.activeSourceIndex].results)||void 0===t||t.forEach(t=>{i.add(l("calcite-list-item",{key:h++,label:t.text,onclick:this._search.bind(this,t)}))})}catch(t){this._abort(),t instanceof Error&&"Aborted"!==t.message&&console.log(t)}})}render(){const{_data:t,_results:e,_state:i}=this;return l("calcite-shell-panel",null,l("calcite-panel",{style:f},l("div",{hidden:"search"!==i},l("calcite-input-text",{clearable:!0,placeholder:"Search service id or address",style:g,afterCreate:this._inputAfterCreate.bind(this)}),l("calcite-list",null,e.toArray())),l("table",{class:c,hidden:"info"!==i},l("tr",null,l("th",null,"Address"),l("td",null,t.ADDRESS)),l("tr",null,l("th",null,"Service id"),l("td",null,t.WSC_ID)),l("tr",null,l("th",null,"Meter size"),l("td",null,t.METER_SIZE_T,'"')),l("tr",null,l("th",null,"Serial no."),l("td",null,t.METER_SN)),l("tr",null,l("th",null,"Register no."),l("td",null,t.METER_REG_SN||"n/a")),l("tr",null,l("th",null,"Meter age"),l("td",null,t.METER_AGE," years"))),l("calcite-button",{appearance:"outline",hidden:"info"!==i,slot:"info"===i?"footer":null,width:"full",afterCreate:this._buttonAfterCreate.bind(this)},"Clear")))}_buttonAfterCreate(t){t.addEventListener("click",this._clear.bind(this))}_inputAfterCreate(t){t.addEventListener("calciteInputTextInput",this._suggest.bind(this))}};e([i()],m.prototype,"_data",void 0),e([i()],m.prototype,"_feature",void 0),e([i()],m.prototype,"_state",void 0),m=e([s("cov.components.WaterMetersShellPanel")],m);export default m;let p=class extends r{get container(){return this._container}set container(t){this._container=t}constructor(t){super(t),this._container=document.createElement("calcite-dialog"),this.items=new o,this.container=this._container,document.body.appendChild(this.container)}render(){const{items:t}=this;return l("calcite-dialog",{heading:"Select water meter",modal:!0,style:_,width:"s"},l("calcite-list",null,t.toArray()))}};p=e([s("Dialog")],p);