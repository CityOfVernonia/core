/* His name was Bruce McNair. Copyright 2025 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{watch as i}from"@arcgis/core/core/reactiveUtils";import{property as s,subclass as r}from"@arcgis/core/core/accessorSupport/decorators";import l from"@arcgis/core/widgets/Widget";import{tsx as o}from"@arcgis/core/widgets/support/widget";import n from"@arcgis/core/core/Collection";import a from"@arcgis/core/Graphic";import c from"@arcgis/core/symbols/SimpleFillSymbol";import{load as u,isLoaded as d,execute as h}from"@arcgis/core/geometry/operators/geodesicBufferOperator";const y="cov--record-surveys",_={background:`${y}_background`,infoPagination:`${y}_info-pagination`,searching:`${y}_searching`};let p=0,v=class extends l{constructor(e){super(e),this._selectedResult=null,this._surveyInfoIndex=null,this._surveyInfos=new n,this._symbols={highlight:new c({color:[255,222,62,.3],outline:{color:[255,222,62],width:2}}),survey:new c({color:[237,81,81,.05],outline:{color:[237,81,81],width:1}}),taxLot:new c({color:[20,158,206,.5],outline:{color:[20,158,206],width:2}})},this._viewState="ready"}postInitialize(){this.addHandles([i(()=>this._popupVisible,this._setState.bind(this)),i(()=>this._selectedFeature,this._setState.bind(this)),i(()=>this._viewState,this._setState.bind(this)),i(()=>this.visible,this._clear.bind(this))])}_clear(){const{_graphics:e,_surveyInfos:t}=this;e&&e.removeAll(),t.removeAll(),this._selectedResult=null,this._viewState="ready"}_loadLayers(){return e(this,void 0,void 0,function*(){const{surveysUrl:e,view:t}=this;this._graphics=new((yield import("@arcgis/core/layers/GraphicsLayer")).default)({listMode:"hide"}),t.map&&(t.map.add(this._graphics),this._surveys=new((yield import("@arcgis/core/layers/GeoJSONLayer")).default)({url:e}))})}_setState(){const{_popupVisible:e,_viewState:t}=this;"results"!==t&&"searching"!==t&&"info"!==t&&"error"!==t&&(this._viewState=e&&this._taxLotSelected()?"selected":"ready")}_search(){return e(this,void 0,void 0,function*(){const{taxLots:e,taxLots:{objectIdField:t},view:i,view:{spatialReference:s},_selectedFeature:r,_symbols:l}=this;if(!this._taxLotSelected())return void(this._viewState="error");this._viewState="searching",this._surveys||(yield this._loadLayers());const{_graphics:n,_surveys:c}=this;try{const y=(yield e.queryFeatures({where:`${t} = ${r.attributes[t]}`,returnGeometry:!0,outSpatialReference:s})).features[0];if(!y)return void(this._viewState="error");y.symbol=l.taxLot.clone(),n.add(new a({geometry:y.geometry,symbol:l.taxLot.clone()})),d()||(yield u());const _=h(y.geometry,20,{unit:"feet"}),v=(yield c.queryFeatures({geometry:_,returnGeometry:!0,outFields:["*"],outSpatialReference:s})).features;i.closePopup(),v.sort((e,t)=>e.attributes.Timestamp>t.attributes.Timestamp?-1:1),v.forEach((e,t)=>{const{_surveyInfos:i,_symbols:s}=this,{attributes:{Client:r,Comments:l,FileDate:a,Firm:c,SurveyDate:u,SurveyType:d,Sheets:h,Subdivision:y,SurveyId:_,SurveyUrl:v}}=e;e.symbol=s.survey.clone(),n.add(e);const g=y||_;i.add({feature:e,listItem:o("calcite-list-item",{key:p++,label:g,description:`${d} - ${u}`,afterCreate:t=>{t.addEventListener("calciteListItemSelect",this._selectHighlightResult.bind(this,e))}},o("calcite-action",{icon:"information",slot:"actions-end",text:"View info",afterCreate:i=>{i.addEventListener("click",()=>{this._selectHighlightResult(e),this._surveyInfoIndex=t,this._viewState="info"})}}),o("calcite-action",{slot:"actions-end",icon:"file-pdf",text:"View PDF",afterCreate:e=>{e.addEventListener("click",()=>{window.open(v,"_blank")})}})),infoTable:o("table",{key:p++,class:"esri-widget__table"},o("tr",null,o("th",null,"Survey id"),o("td",null,o("calcite-link",{href:v,target:"_blank"},_))),o("tr",null,o("th",null,"Type"),o("td",null,d)),y?o("tr",null,o("th",null,"Name"),o("td",null,y)):null,o("tr",null,o("th",null,"Client"),o("td",null,r)),o("tr",null,o("th",null,"Firm"),o("td",null,c)),o("tr",null,o("th",null,"Date"),o("td",null,u)),o("tr",null,o("th",null,"Filed"),o("td",null,a)),o("tr",null,o("th",null,"Comments"),o("td",null,l)),o("tr",null,o("th",null,"Pages"),o("td",null,h.toString())))})}),i.goTo(n.graphics),setTimeout(()=>{this._viewState="results"},1e3)}catch(e){console.log(e),this._viewState="error"}})}_selectHighlightResult(e){const{_graphics:{graphics:t},_selectedResult:i,_symbols:s}=this;i&&(i.symbol=s.survey.clone()),e&&(this._selectedResult=e,e.symbol=s.highlight.clone(),t.reorder(e,t.length-1))}_showSurveySearch(){return e(this,void 0,void 0,function*(){const{_surveys:e,_surveySearchDialog:t}=this;t?t.container.open=!0:(e||(yield this._loadLayers()),this._surveySearchDialog=new((yield import("./SurveySearchDialog")).default)({surveys:this._surveys}),this._surveySearchDialog.container.open=!0)})}_taxLotSelected(){const{taxLots:e,_selectedFeature:t}=this;return t&&t.layer===e}render(){const{_viewState:e}=this;return o("calcite-panel",{heading:"Record Surveys",class:this.classes("results"!==e&&"info"!==e?y:null,"searching"===e||"info"===e?_.background:null)},o("calcite-action",{icon:"search",slot:"header-actions-end",text:"Survey Search",onclick:this._showSurveySearch.bind(this)},o("calcite-tooltip",{slot:"tooltip"},"Survey Search")),"ready"===e?o("calcite-notice",{icon:"cursor-click",kind:"brand",open:!0},o("div",{slot:"message"},"Select a tax lot in the map to search for related surveys and plats.")):null,"selected"===e?o("calcite-notice",{icon:"search",open:!0,style:"--calcite-notice-width: 100%;"},this._renderSelectedMessage(),o("calcite-link",{slot:"link",onclick:this._search.bind(this)},"Search related surveys")):null,"searching"===e?o("div",{class:_.searching},o("calcite-progress",{text:"Searching related surveys",type:"indeterminate"})):null,"results"===e?this._renderResultsList():null,"results"===e?o("calcite-button",{appearance:"outline",slot:"footer",width:"full",onclick:this._clear.bind(this)},"Clear"):null,"info"===e?this._renderInfoPagination():null,"info"===e?this._renderInfo():null,"info"===e?o("calcite-button",{appearance:"outline",slot:"footer",width:"full",onclick:()=>{this._selectHighlightResult(),this._viewState="results"}},"Back"):null,"error"===e?o("calcite-notice",{icon:"exclamation-mark-circle",kind:"danger",open:!0,style:"width: 100%;"},o("div",{slot:"message"},"An error occurred."),o("calcite-link",{slot:"link",onclick:this._clear.bind(this)},"Try again")):null)}_renderInfo(){const{_surveyInfos:e,_surveyInfoIndex:t}=this;if(null===t)return null;const i=e.getItemAt(t);return i?i.infoTable:null}_renderInfoPagination(){const{_surveyInfos:e,_surveyInfoIndex:t}=this;return e.length&&null!==t?o("div",{slot:"content-top",class:_.infoPagination},o("calcite-pagination",{"page-size":"1","start-item":`${t+1}`,"total-items":`${e.length}`,scale:"s",afterCreate:e=>{e.addEventListener("calcitePaginationChange",()=>{const{_surveyInfos:t}=this,i=e.startItem-1;this._surveyInfoIndex=i;const s=t.getItemAt(i);s&&this._selectHighlightResult(s.feature)})}})):null}_renderResultsList(){const{_surveyInfos:e}=this;return o("calcite-list",null,e.toArray().map(e=>e.listItem))}_renderSelectedMessage(){const{_selectedFeature:e}=this;return this._taxLotSelected()?o("div",{slot:"message"},e.attributes.TAXLOT_ID,o("br",null),e.attributes.OWNER):null}};t([s({aliasOf:"view.popup.visible"})],v.prototype,"_popupVisible",void 0),t([s({aliasOf:"view.popup.selectedFeature"})],v.prototype,"_selectedFeature",void 0),t([s()],v.prototype,"_selectedResult",void 0),t([s()],v.prototype,"_surveyInfoIndex",void 0),t([s()],v.prototype,"_viewState",void 0),v=t([r("cov.components.RecordSurveys")],v);export default v;