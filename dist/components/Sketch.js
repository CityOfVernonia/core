/* His name was Bruce McNair. Copyright 2025 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import{property as i,subclass as c}from"@arcgis/core/core/accessorSupport/decorators";import o from"@arcgis/core/core/Collection";import{watch as l,whenOnce as s}from"@arcgis/core/core/reactiveUtils";import{tsx as a}from"@arcgis/core/widgets/support/widget";import n from"@arcgis/core/widgets/Widget";import r,{COLORS as d,POINT_SYMBOL as h,TEXT_SYMBOL as p}from"./Sketch/Sketch";import{buffer as u,offset as _,polygonVertices as v,polylineVertices as f}from"../support/geometryUtils";import{queryFeatureGeometry as b}from"../support/layerUtils";import{referenceElement as y}from"./support";import m from"@arcgis/core/Color";const g="cov--sketch",S={base:g,actionBars:`${g}_action-bars`,colorPicker:`${g}_color-picker`,notice:`${g}_notice`,options:`${g}_options`},k="cov_components_sketch",w="cov_components_sketch_select",x="cov_components_sketch_selected";let C=0,E=class extends n{constructor(e){super(e),this.offsetProjectionWkid=102970,this._canRedo=!1,this._canUndo=!1,this._createText=!1,this._graphicsCount=0,this._selectState=!1,this._selectedGraphics=new o,this._selectedGraphicsListItems=new o,this._sketch=new r,this._toolState="none",this._viewState="sketch"}postInitialize(){return e(this,void 0,void 0,(function*(){const{view:e,_sketch:t}=this;yield e.when(),t.view=e;const i=()=>{this._canUndo=t.canUndo(),this._canRedo=t.canRedo()};s((()=>{var t;return null===(t=e.popup)||void 0===t?void 0:t.container})).then((()=>{const t=e.popup;this.addHandles(l((()=>t.visible),(e=>{const{_viewState:t}=this;e||"buffer"!==t&&"offset"!==t||this._reset()})),k)})),this.addHandles([t.on("create",this._createEvent.bind(this)),t.on("update",this._updateEvent.bind(this)),t.on("create",i),t.on("update",i),t.on("redo",i),t.on("undo",i),l((()=>this._createText),(e=>{t.pointSymbol=e?p:h})),l((()=>this.visible),(e=>{e||this._reset()}))],k)}))}_addSelectedFeature(){return e(this,void 0,void 0,(function*(){const{view:{spatialReference:e},_selectedFeature:t,_sketch:i}=this;if(!t)return;const c=t.layer||t.sourceLayer;if(!c)return;const o=yield b({graphic:t,layer:c,outSpatialReference:e});o&&i.addGeometry(o)}))}_addVertices(){return e(this,void 0,void 0,(function*(){const{view:{spatialReference:e},_selectedFeature:t,_selectedGraphic:i,_sketch:c}=this,o=i||t;if(!o)return;const l=o.layer||o.sourceLayer;if(!l)return;let s=o.geometry;s&&("graphics"!==l.type&&(s=yield b({layer:l,graphic:o,outSpatialReference:e})),s&&("polyline"===s.type&&f(s,e).forEach((e=>{c.addGeometry(e)})),"polygon"===s.type&&v(s,e).forEach((e=>{c.addGeometry(e)}))))}))}_buffer(t){return e(this,void 0,void 0,(function*(){t.preventDefault();const{view:{spatialReference:e},_bufferInput:i,_selectedFeature:c,_selectedGraphic:o,_sketch:l}=this,s=o||c;if(!s)return void this._reset();const a=s.layer||s.sourceLayer;if(!a)return void this._reset();let n=s.geometry;if(!n)return void this._reset();if("graphics"!==a.type&&(n=yield b({layer:a,graphic:s,outSpatialReference:e})),!n)return void this._reset();const r=yield u(n,Number(i.value),"feet");l.addGeometry(r),this._cancel()}))}_cancel(){const{_selectedGraphic:e}=this;this._viewState=e?"edit":"sketch"}_create(e){const{_sketch:t}=this;"active"===t.state&&this._reset(),this._toolState=e,"text"===e?(this._createText=!0,t.create("point")):t.create(e)}_createEvent(e){const{_createText:t,_sketch:i}=this,{graphic:c,state:o}=e;if("cancel"===o)return void this._reset();if("complete"!==o)return;if("complete"===o&&!c.geometry)return void this._reset();const l=c.geometry.type;c.symbol=c.symbol.clone(),i.layer.remove(c),t?(i.text.add(c),this._newTextGraphic=c,this._viewState="new-text",this._createText=!1):i[l].add(c),this._toolState="none"}_highlight(e){const{_sketch:t}=this;this.addHandles(t[`${e.layer.title}View`].highlight(e),x)}_highlightGraphic(e){this.removeHandles(x),this._highlight(e)}_highlightSelectedGraphics(){const{_selectedGraphics:e,_viewState:t}=this;"selected"===t&&(this.removeHandles(x),e.forEach(this._highlight.bind(this)))}_newText(e){e.preventDefault();const{_newTextInput:t,_newTextGraphic:i}=this;if(!t||!i)return void this._reset();this._viewState="sketch";const c=i.symbol.clone();c.text=t.value||"New Text",i.symbol=c}_offset(t){return e(this,void 0,void 0,(function*(){t.preventDefault();const{offsetProjectionWkid:e,view:{spatialReference:i},_offsetInput:c,_offsetSelect:o,_selectedFeature:l,_selectedGraphic:s,_sketch:a}=this,n=s||l;if(!n)return void this._reset();const r=n.layer||n.sourceLayer;if(!r)return void this._reset();let d=n.geometry;if(!d)return void this._reset();if("graphics"!==r.type&&(d=yield b({layer:r,graphic:n,outSpatialReference:i})),!d||"polyline"!==d.type)return void this._reset();(yield _(d,o.value,Number(c.value),"feet",e)).forEach((e=>{a.addGeometry(e)})),this._cancel()}))}_reset(){const{_sketch:e}=this;e.cancel(),this._selectReset(),this._createText=!1,this._toolState="none",this._viewState="sketch"}_select(){const{view:t,_selectedGraphics:i,_selectedGraphicsListItems:c,_selectState:o,_sketch:{point:l,polygon:s,polyline:n,text:r}}=this;if(this._selectState=!o,!this._selectState)return this._reset(),void this.removeHandles(w);t.closePopup(),this.removeHandles(x);const d=t.on("click",(o=>e(this,void 0,void 0,(function*(){o.stopPropagation();const e=(yield t.hitTest(o,{include:[l,s,n,r]})).results,d=e.length;d?1===d?this._selectGraphic(e[0].graphic):(c.removeAll(),i.removeAll(),c.addMany(e.map((e=>{const{graphic:t}=e;i.add(t),this._highlight(t);const c=t.layer.title,o=t.symbol?t.symbol.type:"",l=c.charAt(0).toUpperCase()+c.slice(1),s="text"===o?"text-large":"point"===c?"point":"polyline"===c?"line":"polygon-vertices";return a("calcite-list-item",{key:C++,label:l,onclick:this._selectGraphic.bind(this,t),onmouseenter:this._highlightGraphic.bind(this,t)},a("calcite-icon",{icon:s,scale:"s",slot:"content-end"}))}))),this._viewState="selected"):this._viewState="sketch"}))));this.addHandles(d,w)}_selectGraphic(e){this._selectReset(),this._selectedGraphic=e,this._update(e),this._viewState="edit"}_selectReset(){var e,t;const{_selectedGraphic:i,_selectedGraphics:c}=this;this.removeHandles([w,x]),i&&"text"===(null===(e=i.symbol)||void 0===e?void 0:e.type)&&""===(null===(t=i.symbol)||void 0===t?void 0:t.text)&&(i.symbol.text="New Text"),this._selectState=!1,this._selectedGraphic=null,c.removeAll()}_setSymbolProperty(e,t){const{_selectedGraphic:i}=this;if(!i)return;const{symbol:c}=i;c&&(c.set({[e]:t}),i.symbol=c.clone())}_update(e){const{_sketch:t,_sketch:{layer:i}}=this;e.layer.remove(e),i.add(e),t.update(e)}_updateEvent(e){var t,i;const{_sketch:c,_sketch:{layer:o,text:l}}=this,{state:s,graphics:a}=e;if("complete"!==s)return;const n=a[0],r=null===(t=n.geometry)||void 0===t?void 0:t.type,d=null===(i=n.symbol)||void 0===i?void 0:i.type;o.removeAll(),"text"===d?l.add(n):c[r].add(n),this._viewState="sketch",setTimeout(this._selectReset.bind(this),500)}render(){const{_sketch:{snappingOptions:{featureEnabled:t,selfEnabled:i}},_viewState:c}=this;return a("calcite-panel",{class:S.base,heading:"Sketch"},a("calcite-action",{icon:"gear",slot:"header-actions-end",text:"Options"}),a("calcite-popover",{"auto-close":"",closable:!0,heading:"Options","overlay-positioning":"fixed",placement:"bottom-end",scale:"s",afterCreate:y.bind(this)},a("div",{class:S.options},a("calcite-label",{layout:"inline"},a("calcite-switch",{checked:t,afterCreate:e=>{e.addEventListener("calciteSwitchChange",(()=>{this._sketch.snappingOptions.featureEnabled=e.checked}))}}),"Snapping"),a("calcite-label",{layout:"inline",style:"--calcite-label-margin-bottom: 0;"},a("calcite-switch",{checked:i,afterCreate:e=>{e.addEventListener("calciteSwitchChange",(()=>{this._sketch.snappingOptions.selfEnabled=e.checked}))}}),"Guides"))),a("calcite-action",{icon:"save",slot:"header-actions-end",text:"Save/Load",onclick:()=>e(this,void 0,void 0,(function*(){const{_sketchSaveLoad:e}=this;e||(this._sketchSaveLoad=new((yield import("./Sketch/SketchSaveLoad")).default)({sketch:this._sketch})),this._sketchSaveLoad.container.open=!0,this._reset()}))}),"buffer"===c?this._renderBuffer():"delete-all"===c?this._renderDeleteAll():"edit"===c?this._renderEdit():"new-text"===c?this._renderNewText():"offset"===c?this._renderOffset():"selected"===c?this._renderSelected():"sketch"===c?this._renderSketch():null)}_renderBuffer(){return[a("form",{onsubmit:this._buffer.bind(this)},a("calcite-label",{style:"--calcite-label-margin-bottom: 0;"},"Buffer distance",a("calcite-input-number",{integer:!0,max:"26400",min:"5","suffix-text":"feet",value:"250",afterCreate:e=>{this._bufferInput=e,e.setFocus()}}))),a("calcite-button",{appearance:"outline",slot:"footer",width:"half",onclick:this._cancel.bind(this)},"Cancel"),a("calcite-button",{slot:"footer",width:"half",onclick:this._buffer.bind(this)},"Buffer")]}_renderDeleteAll(){return[a("calcite-notice",{icon:"trash",kind:"danger",open:!0,style:"width: 100%;"},a("div",{slot:"message"},"Delete all sketch graphics?")),a("calcite-button",{appearance:"outline",slot:"footer",width:"half",onclick:()=>{this._viewState="sketch"}},"Cancel"),a("calcite-button",{kind:"danger",slot:"footer",width:"half",onclick:()=>{const{_sketch:e}=this;e.deleteAll(),this._viewState="sketch"}},"Delete")]}_renderEdit(){var e;const{_canRedo:t,_canUndo:i,_selectedGraphic:c,_sketch:o}=this,l=c&&c.geometry?c.geometry.type:null,s="point"===l,n="polyline"!==l,r=l?`buffer-${l}`:"buffer-point",d=c?null===(e=c.symbol)||void 0===e?void 0:e.type:null,h="simple-marker"===d?this._renderSimpleMarkerSymbolEditor(c):"simple-line"===d?this._renderSimpleLineSymbolEditor(c):"simple-fill"===d?this._renderSimpleFillSymbolEditor(c):"text"===d?this._renderTextSymbolEditor(c):[];return[a("calcite-action-bar",{"expand-disabled":"",layout:"horizontal"},a("calcite-action",{disabled:!i,icon:"undo",scale:"s",onclick:o.undo.bind(o)}),a("calcite-action",{disabled:!t,icon:"redo",scale:"s",onclick:o.redo.bind(o)}),a("calcite-action",{icon:"trash",scale:"s",onclick:()=>{const{_selectedGraphic:e,_sketch:t}=this;e&&(t.complete(),e.layer.remove(e),this._viewState="sketch",this._selectReset())}}),a("calcite-action",{disabled:s,icon:"vertex-plus",scale:"s",onclick:this._addVertices.bind(this)}),a("calcite-action",{icon:r,scale:"s",onclick:()=>{this._viewState="buffer"}}),a("calcite-action",{disabled:n,icon:"offset",scale:"s",onclick:()=>{this._viewState="offset"}})),h,a("calcite-button",{appearance:"outline",slot:"footer",width:"full",onclick:this._reset.bind(this)},"Done")]}_renderNewText(){return[a("form",{onsubmit:this._newText.bind(this)},a("calcite-label",null,"New text",a("calcite-input",{value:"New Text",afterCreate:e=>{this._newTextInput=e,e.setFocus(),setTimeout((()=>{e.selectText()}),0),e.addEventListener("calciteInputInput",(()=>{const{_newTextGraphic:t}=this;if(!t)return;const i=t.symbol.clone();i.text=e.value,t.symbol=i}))}}))),a("calcite-button",{appearance:"outline",slot:"footer",width:"full",onclick:this._newText.bind(this)},"Done")]}_renderOffset(){return[a("form",{onsubmit:this._offset.bind(this)},a("calcite-label",null,"Offset distance",a("calcite-input-number",{integer:!0,max:"5280",min:"5","suffix-text":"feet",value:"30",afterCreate:e=>{this._offsetInput=e,e.setFocus()}})),a("calcite-label",{style:"--calcite-label-margin-bottom: 0;"},"Sides",a("calcite-select",{afterCreate:e=>{this._offsetSelect=e}},a("calcite-option",{selected:!0,value:"both"},"Both"),a("calcite-option",{value:"left"},"Left"),a("calcite-option",{value:"right"},"Right")))),a("calcite-button",{appearance:"outline",slot:"footer",width:"half",onclick:this._cancel.bind(this)},"Cancel"),a("calcite-button",{slot:"footer",width:"half",onclick:this._offset.bind(this)},"Offset")]}_renderSelected(){const{_selectedGraphicsListItems:e}=this;return a("div",{key:C++,onmouseleave:this._highlightSelectedGraphics.bind(this)},a("calcite-notice",{class:S.notice,open:!0},a("div",{slot:"message"},`${e.length} sketch graphics selected`),a("calcite-link",{slot:"link"},"Clear selection")),a("calcite-list",null,e.toArray()))}_renderSimpleFillSymbolEditor(e){const{color:t,color:{a:i},outline:{color:c,style:o,width:l}}=e.symbol;return[a("calcite-label",null,"Color",a("div",{afterCreate:e=>{new G({color:t,container:e}).on("color-change",(e=>{this._setSymbolProperty("color.r",e.r),this._setSymbolProperty("color.g",e.g),this._setSymbolProperty("color.b",e.b)}))}})),a("calcite-label",null,"Opacity",a("calcite-slider",{afterCreate:e=>{Object.assign(e,{max:1,min:0,snap:!0,step:.1,value:i}),e.addEventListener("calciteSliderInput",(()=>{this._setSymbolProperty("color.a",e.value)}))}})),a("calcite-label",null,"Line color",a("div",{afterCreate:e=>{new G({color:c,container:e}).on("color-change",(e=>{this._setSymbolProperty("outline.color",e)}))}})),a("calcite-label",null,"Line",a("calcite-select",{afterCreate:e=>{e.addEventListener("calciteSelectChange",(()=>{this._setSymbolProperty("outline.style",e.selectedOption.value)}))}},a("calcite-option",{selected:"solid"===o,value:"solid"},"Solid"),a("calcite-option",{selected:"dash"===o,value:"dash"},"Dash"),a("calcite-option",{selected:"dot"===o,value:"dot"},"Dot"),a("calcite-option",{selected:"dash-dot"===o,value:"dash-dot"},"Dash Dot"))),a("calcite-label",{style:"--calcite-label-margin-bottom: 0;"},"Width",a("calcite-slider",{afterCreate:e=>{Object.assign(e,{max:6,min:1,snap:!0,step:1,value:l}),e.addEventListener("calciteSliderInput",(()=>{this._setSymbolProperty("outline.width",e.value)}))}}))]}_renderSimpleLineSymbolEditor(e){const{color:t,style:i,width:c}=e.symbol;return[a("calcite-label",null,"Color",a("div",{afterCreate:e=>{new G({color:t,container:e}).on("color-change",(e=>{this._setSymbolProperty("color",e)}))}})),a("calcite-label",null,"Line",a("calcite-select",{afterCreate:e=>{e.addEventListener("calciteSelectChange",(()=>{this._setSymbolProperty("style",e.selectedOption.value)}))}},a("calcite-option",{selected:"solid"===i,value:"solid"},"Solid"),a("calcite-option",{selected:"dash"===i,value:"dash"},"Dash"),a("calcite-option",{selected:"dot"===i,value:"dot"},"Dot"),a("calcite-option",{selected:"dash-dot"===i,value:"dash-dot"},"Dash Dot"))),a("calcite-label",{style:"--calcite-label-margin-bottom: 0;"},"Width",a("calcite-slider",{afterCreate:e=>{Object.assign(e,{max:6,min:1,snap:!0,step:1,value:c}),e.addEventListener("calciteSliderInput",(()=>{this._setSymbolProperty("width",e.value)}))}}))]}_renderSimpleMarkerSymbolEditor(e){const{color:t,outline:{color:i,width:c},size:o,style:l}=e.symbol;return[a("calcite-label",null,"Color",a("div",{afterCreate:e=>{new G({color:t,container:e}).on("color-change",(e=>{this._setSymbolProperty("color",e)}))}})),a("calcite-label",null,"Shape",a("calcite-select",{style:"width: 100%;",afterCreate:e=>{e.addEventListener("calciteSelectChange",(()=>{this._setSymbolProperty("style",e.selectedOption.value)}))}},a("calcite-option",{selected:"circle"===l,value:"circle"},"Circle"),a("calcite-option",{selected:"square"===l,value:"square"},"Square"),a("calcite-option",{selected:"diamond"===l,value:"diamond"},"Diamond"))),a("calcite-label",null,"Size",a("calcite-slider",{afterCreate:e=>{Object.assign(e,{max:18,min:6,snap:!0,step:1,value:o}),e.addEventListener("calciteSliderInput",(()=>{this._setSymbolProperty("size",e.value)}))}})),a("calcite-label",null,"Outline color",a("div",{afterCreate:e=>{new G({color:i,container:e}).on("color-change",(e=>{this._setSymbolProperty("outline.color",e)}))}})),a("calcite-label",{style:"--calcite-label-margin-bottom: 0;"},"Outline width",a("calcite-slider",{afterCreate:e=>{Object.assign(e,{max:4,min:0,snap:!0,step:1,value:c}),e.addEventListener("calciteSliderInput",(()=>{this._setSymbolProperty("outline.width",e.value)}))}}))]}_renderSketch(){const{_canRedo:e,_canUndo:t,_graphicsCount:i,_popupVisible:c,_selectState:o,_selectedFeature:l,_sketch:s,_toolState:n}=this,r=c&&l?l:null,d=r&&r.geometry?r.geometry.type:null,h=!r,p=!r||"point"===d,u=!r||r&&"polyline"!==d,_=d?`buffer-${d}`:"buffer-point";return a("div",{class:S.actionBars},a("calcite-action-bar",{"expand-disabled":"",layout:"horizontal"},a("calcite-action",{active:"point"===n,icon:"point",scale:"s",onclick:this._create.bind(this,"point")}),a("calcite-action",{active:"polyline"===n,icon:"line",scale:"s",onclick:this._create.bind(this,"polyline")}),a("calcite-action",{active:"polygon"===n,icon:"polygon-vertices",scale:"s",onclick:this._create.bind(this,"polygon")}),a("calcite-dropdown",{"overlay-positioning":"fixed"},a("calcite-action",{active:"freehandPolygon"===n||"freehandPolyline"===n,icon:"freehand",scale:"s",slot:"trigger"}),a("calcite-dropdown-group",{"selection-mode":"none"},a("calcite-dropdown-item",{"icon-start":"freehand",onclick:this._create.bind(this,"freehandPolyline")},"Polyline"),a("calcite-dropdown-item",{"icon-start":"freehand-area",onclick:this._create.bind(this,"freehandPolygon")},"Polygon"))),a("calcite-dropdown",{"overlay-positioning":"fixed"},a("calcite-action",{active:"circle"===n||"rectangle"===n,icon:"rectangle",scale:"s",slot:"trigger"}),a("calcite-dropdown-group",{"selection-mode":"none"},a("calcite-dropdown-item",{"icon-start":"rectangle",onclick:this._create.bind(this,"rectangle")},"Rectangle"),a("calcite-dropdown-item",{"icon-start":"circle",onclick:this._create.bind(this,"circle")},"Circle"))),a("calcite-action",{active:"text"===n,icon:"text-large",scale:"s",onclick:this._create.bind(this,"text")})),a("calcite-action-bar",{"expand-disabled":"",layout:"horizontal"},a("calcite-action",{active:o,disabled:i<1,icon:"cursor",scale:"s",onclick:this._select.bind(this)}),a("calcite-action",{disabled:!t,icon:"undo",scale:"s",onclick:s.undo.bind(s)}),a("calcite-action",{disabled:!e,icon:"redo",scale:"s",onclick:s.redo.bind(s)}),a("calcite-action",{disabled:i<1,icon:"trash",scale:"s",onclick:()=>{this._reset(),this._viewState="delete-all"}})),a("calcite-action-bar",{"expand-disabled":"",layout:"horizontal"},a("calcite-action",{disabled:h,icon:"add-layer",scale:"s",onclick:this._addSelectedFeature.bind(this)}),a("calcite-action",{disabled:p,icon:"vertex-plus",scale:"s",onclick:this._addVertices.bind(this)}),a("calcite-action",{disabled:h,icon:_,scale:"s",onclick:()=>{this._viewState="buffer"}}),a("calcite-action",{disabled:u,icon:"offset",scale:"s",onclick:()=>{this._viewState="offset"}})))}_renderTextSymbolEditor(e){const{color:t,font:{size:i},haloColor:c,text:o}=e.symbol;return[a("calcite-label",null,"Text",a("calcite-input",{value:o,afterCreate:e=>{e.addEventListener("calciteInputInput",(()=>{this._setSymbolProperty("text",e.value)}))}})),a("calcite-label",null,"Color",a("div",{afterCreate:e=>{new G({color:t,container:e}).on("color-change",(e=>{this._setSymbolProperty("color",e)}))}})),a("calcite-label",null,"Size",a("calcite-slider",{afterCreate:e=>{Object.assign(e,{max:18,min:10,snap:!0,step:1,value:i}),e.addEventListener("calciteSliderInput",(()=>{this._setSymbolProperty("font.size",e.value)}))}})),a("calcite-label",{style:"--calcite-label-margin-bottom: 0;"},"Halo color",a("div",{afterCreate:e=>{new G({color:c,container:e}).on("color-change",(e=>{this._setSymbolProperty("haloColor",e)}))}}))]}};t([i()],E.prototype,"_canRedo",void 0),t([i()],E.prototype,"_canUndo",void 0),t([i()],E.prototype,"_createText",void 0),t([i({aliasOf:"_sketch.graphicsCount"})],E.prototype,"_graphicsCount",void 0),t([i({aliasOf:"view.popup.visible"})],E.prototype,"_popupVisible",void 0),t([i()],E.prototype,"_selectState",void 0),t([i({aliasOf:"view.popup.selectedFeature"})],E.prototype,"_selectedFeature",void 0),t([i()],E.prototype,"_selectedGraphic",void 0),t([i()],E.prototype,"_selectedGraphics",void 0),t([i()],E.prototype,"_selectedGraphicsListItems",void 0),t([i()],E.prototype,"_toolState",void 0),t([i()],E.prototype,"_viewState",void 0),E=t([c("cov.components.Sketch")],E);export default E;let G=class extends n{constructor(e){super(e),this.colors=[];for(const e in d)this.colors.push(new m(d[e]).toCss())}render(){return a("div",{class:S.colorPicker},this._renderSwatches())}_renderSwatches(){return this.colors.map((e=>{const t=e===this.color.toCss();return a("calcite-color-picker-swatch",{active:t,color:e,scale:"s",afterCreate:t=>{t.addEventListener("click",(()=>{this.color=new m(e),this.emit("color-change",this.color)}))}})}))}};t([i()],G.prototype,"color",void 0),G=t([c("cov.components.Sketch.ColorPicker")],G);