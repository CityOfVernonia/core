/* His name was Bruce McNair. Copyright 2025 City of Vernonia, Oregon. */
import{__awaiter as t,__decorate as e}from"tslib";import{subclass as n}from"@arcgis/core/core/accessorSupport/decorators";import l from"@arcgis/core/widgets/Widget";import{tsx as o}from"@arcgis/core/widgets/support/widget";import{referenceElement as r}from"./../components/support";import i from"@arcgis/core/PopupTemplate";import{propertyInfoUrl as s,taxMapUrl as a}from"./../support/taxLotUtils";import{load as c,isLoaded as d,execute as u}from"@arcgis/core/geometry/operators/geodesicBufferOperator";let h=0;const f="--calcite-loader-progress-color-inline: var(--calcite-color-brand);",g="max-width: 165px; padding: 0.25rem; ";let p=class extends i{constructor(t){super(t),this.outFields=["*"],this.title="{TAXLOT_ID}",this.content=t=>{const{infoLayers:e}=this;return new _({graphic:t.graphic,infoLayers:e}).container}}};p=e([n("cov.popups.TaxLotPopupTemplate")],p);export default p;class _ extends l{get container(){return this._container}set container(t){this._container=t}constructor(t){super(t),this._container=document.createElement("table"),this._flood=o("tr",null,o("th",null,"Flood zones"),o("td",{style:f},o("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"}))),this._mailing=o("tr",null,o("th",null,"Mailing address"),o("td",{style:f},o("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"}))),this._zoning=o("tr",null,o("th",null,"Zoning"),o("td",{style:f},o("calcite-loader",{inline:!0,label:"Loading",scale:"s",text:"Loading"}))),this.graphic=t.graphic,this.infoLayers=t.infoLayers}postInitialize(){return t(this,void 0,void 0,(function*(){const{graphic:{geometry:t,attributes:{VERNONIA:e}},infoLayers:n}=this;if(this._mailingInfo(),!t||!n||0===e)return;d()||(yield c());const l=u(t,-1,{unit:"feet"});this._zoningInfo(l),this._floodInfo(l)}))}_floodInfo(e){return t(this,void 0,void 0,(function*(){const{infoLayers:t}=this;if(!t)return;const{flood:n}=t;try{const t=yield n.queryFeatures({geometry:e,outFields:["flood_zone"],returnGeometry:!1}),l=[];t.features.forEach((t=>{const{flood_zone:e}=t.attributes;-1===l.indexOf(e)&&l.push(e)})),this._flood=o("tr",null,o("th",null,o("calcite-link",{"icon-end":"information"},"Flood zones"),o("calcite-popover",{"auto-close":"",closable:!0,scale:"s",afterCreate:r},o("div",{style:g},"Some portion of the tax lot is affected by the indicated flood zones. Turn on flood hazard layer to view flood zones."))),o("td",null,l.length?l.map((t=>o("div",{key:h++},t))):"None")),this.scheduleRender()}catch(t){console.log(t),this._flood=o("tr",null,o("th",null,"Flood zones"),o("td",null,"An error occurred")),this.scheduleRender()}}))}_mailingInfo(){return t(this,void 0,void 0,(function*(){var t;const{graphic:e}=this;try{const n=e.layer,l=e.attributes[n.objectIdField],r=null===(t=(yield n.queryRelatedFeatures({objectIds:[l],outFields:["M_ADDRESS","M_CITY","M_STATE","M_ZIP"],relationshipId:0}))[l])||void 0===t?void 0:t.features[0];if(!r)return void(this._mailing=o("tr",null,o("th",null,"Mailing address"),o("td",null,"Unknown")));const{M_ADDRESS:i,M_CITY:s,M_STATE:a,M_ZIP:c}=r.attributes;this._mailing=o("tr",null,o("th",null,"Mailing address"),o("td",null,i,o("br",null),s,", ",a," ",c)),this.scheduleRender()}catch(t){console.log(t),this._mailing=o("tr",null,o("th",null,"Mailing address"),o("td",null,"An error occurred")),this.scheduleRender()}}))}_zoningInfo(e){return t(this,void 0,void 0,(function*(){const{infoLayers:t}=this;if(!t)return;const{zoning:n}=t;try{const t=yield n.queryFeatures({geometry:e,outFields:["localZCode","localZDesc"],returnGeometry:!1}),l=[];t.features.forEach((t=>{const{localZCode:e,localZDesc:n}=t.attributes,o=`${e} - ${n}`;-1===l.indexOf(o)&&l.push(o)})),this._zoning=o("tr",null,o("th",null,"Zoning"),o("td",null,l.map((t=>o("div",{key:h++},t))))),this.scheduleRender()}catch(t){console.log(t),this._zoning=o("tr",null,o("th",null,"Zoning"),o("td",null,"An error occurred")),this.scheduleRender()}}))}render(){const{infoLayers:t,_flood:e,_mailing:n,_zoning:l}=this,{VERNONIA:r}=this.graphic.attributes;return o("table",{class:"cov--feature-table"},this._renderTaxLotInfo(),n,t&&1===r?l:null,t&&1===r?e:null)}_renderTaxLotInfo(){const{TAXLOT_ID:t,ACCELA_MT:e,ACCOUNT_IDS:n,TAXMAP:l,ADDRESS:r,OWNER:i,ACRES:c,SQ_FEET:d}=this.graphic.attributes,u=r?o("tr",null,o("th",null,"Address"),o("td",null,r)):null;let h="Unknown",f=[];return n&&(f=n.split(","),h=1===f.length?o("calcite-link",{href:`${s(f[0])}`,target:"_blank"},f[0]):f.map(((t,e)=>o("span",null,o("calcite-link",{href:`${s(t)}`,target:"_blank"},t),e<f.length-1?o("span",null,"  "):"")))),[o("tr",null,o("th",null,"Tax lot"),o("td",null,o("calcite-link",{href:`https://vernonia-tax-lot.netlify.app/${t}/`,target:"_blank"},t))),o("tr",null,o("th",null,"Accela id"),o("td",null,e)),o("tr",null,o("th",null,"Tax map"),o("td",null,o("calcite-link",{href:`${a(l)}`,target:"_blank"},l))),o("tr",null,o("th",null,"Owner"),o("td",null,i||"Unknown")),u,o("tr",null,o("th",null,"Area"),o("td",null,c," acres  ",d.toLocaleString()," sq ft")),o("tr",null,o("th",null,"Tax account",f.length>1?"s":""),o("td",null,h))]}}