/* His name was Bruce McNair. Copyright 2024 City of Vernonia, Oregon. */
import{__awaiter as t,__decorate as e}from"tslib";import i from"@arcgis/core/config";import o from"@arcgis/core/identity/IdentityManager";import{watch as n}from"@arcgis/core/core/reactiveUtils";import{subclass as a,property as s}from"@arcgis/core/core/accessorSupport/decorators";import l from"@arcgis/core/widgets/Widget";import{tsx as r}from"@arcgis/core/widgets/support/widget";import c from"@arcgis/core/core/Collection";import d from"../support/logo";import p from"../widgets/Loader";import h from"../widgets/Disclaimer";import u from"../widgets/ViewControl2D";import v from"../support/basemapToggle";import{subscribe as m}from"pubsub-js";const g="cov-layouts--map-application",f="cov-layouts--map-application_header",w="cov-layouts--map-application_header--content cov-layouts--map-application_header--title",_="cov-layouts--map-application_header--content cov-layouts--map-application_header--controls",b="cov-layouts--map-application_user-control",y="cov-layouts--map-application_user-control--popover",C="cov-layouts--map-application_view";let A=0;const k="show-alert";export const showAlertTopic=()=>k;let E=class extends l{constructor(t){super(t),this.container=document.createElement("calcite-shell"),this.disclaimerOptions={},this.includeDisclaimer=!0,this.loaderOptions={},this.title="Vernonia",this.viewControlOptions={},this.loaded=!1,this._alerts=new c,this._actionBarActionGroups=new c,this._visibleWidget=null,this._shellPanelWidgets=new c,document.body.append(this.container)}postInitialize(){return t(this,void 0,void 0,(function*(){const{disclaimerOptions:t,endWidgetInfo:e,loaderOptions:n,nextBasemap:a,title:s,view:l,view:{ui:r},viewControlOptions:c,widgetInfos:d}=this;let{includeDisclaimer:g}=this;const f=new p(n.title?n:Object.assign(Object.assign({},n),{title:s}));r.remove("zoom"),r.add(new u(Object.assign({view:l},c)),"top-left"),a&&v(l,a,"bottom-right"),this._widgets(d),e&&this._widgets([e],!0);try{(yield o.checkSignInStatus(i.portalUrl))&&(g=!1)}catch(t){g=!0}g&&!h.isAccepted()&&new h(t),m(k,((t,e)=>{this._alertEvent(e)})),yield l.when(),f.end(),this.loaded=!0,this.emit("load")}))}showAlert(t){this._alertEvent(t)}showWidget(t){this._visibleWidget=t}_alertEvent(t){const{_alerts:e}=this,{duration:i,icon:o,kind:n,label:a,link:s,message:l,title:c,width:d}=t;e.add(r("calcite-alert",{key:A++,icon:o||null,kind:n||"brand",open:"",label:a,"auto-close":i?"":null,"auto-close-duration":i||null,style:d?`--calcite-alert-width: ${d}px`:null},c?r("div",{slot:"title"},c):null,r("div",{slot:"message"},l),s?r("calcite-link",{href:s.href||null,slot:"link",target:s.href?"_blank":null,onclick:t=>{t.click&&t.addEventListener("click",t.click)}},s.text):null))}_widgets(t,e){const{_actionBarActionGroups:i,_shellPanelWidgets:o}=this;let a=[];t.forEach(((s,l)=>{const{icon:c,groupEnd:d,text:p,type:h,widget:u}=s;let v;switch(this.addHandles(u.on(k,this._alertEvent.bind(this))),h){case"modal":{u.container=document.createElement("calcite-modal"),document.body.append(u.container);const t=u;u.container.addEventListener("calciteModalOpen",(()=>{t.onShow&&"function"==typeof t.onShow&&t.onShow()})),u.container.addEventListener("calciteModalClose",(()=>{t.onHide&&"function"==typeof t.onHide&&t.onHide()}));break}case"panel":v=r("calcite-panel",{afterCreate:t=>{u.container=t,this._widgetEvents(u)}});break;case"flow":v=r("calcite-flow",{afterCreate:t=>{u.container=t,this._widgetEvents(u)}})}"modal"!==h&&(u.visible=!1),v&&o.add(v);const m=r("calcite-action",{icon:c,text:p,afterCreate:t=>{"modal"===h?t.addEventListener("click",(()=>{u.container.open=!0})):(t.addEventListener("click",(()=>{this._visibleWidget=this._visibleWidget===u.id?null:u.id})),this.addHandles(n((()=>this._visibleWidget),(e=>{t.active=e===u.id}))))}},r("calcite-tooltip",{"close-on-click":"",slot:"tooltip"},p));a.push(m),(d||l+1===t.length)&&(i.add(r("calcite-action-group",{key:A++,slot:e?"actions-end":null},a)),a=[])}))}_widgetEvents(t){this.addHandles([t.on(k,this._alertEvent.bind(this)),n((()=>this._visibleWidget),((e,i)=>{t.visible=e===t.id,e===t.id&&t.onShow&&"function"==typeof t.onShow&&t.onShow(),i&&i===t.id&&t.onHide&&"function"==typeof t.onHide&&t.onHide()}))])}render(){const{title:t,_alerts:e,_actionBarActionGroups:i,_shellPanelWidgets:o}=this;return r("calcite-shell",{class:g,"content-behind":""},r("div",{class:f,slot:"header"},r("div",{class:w},r("img",{src:d}),r("div",null,t)),r("div",{class:_},r("div",{afterCreate:this._searchAfterCreate.bind(this)}),r("div",{afterCreate:this._userControlAfterCreate.bind(this)}))),r("div",{class:C,afterCreate:this._viewAfterCreate.bind(this)}),r("calcite-shell-panel",{"display-mode":"float",position:"end",slot:"panel-end"},r("calcite-action-bar",{slot:"action-bar",afterCreate:this._actionBarAfterCreate.bind(this)},i.toArray()),o.toArray()),r("div",{slot:"footer",afterCreate:this._footerAfterCreate.bind(this)}),r("div",{slot:"alerts"},e.toArray()))}_actionBarAfterCreate(t){const{view:e}=this,i=()=>{const i=t.getBoundingClientRect().width;e.padding=Object.assign(Object.assign({},e.padding),{right:i})};i(),new ResizeObserver((()=>{i()})).observe(t)}_footerAfterCreate(t){const{footer:e}=this;e?e.container=t:t.remove()}_userControlAfterCreate(t){const{oAuth:e}=this;e?new O({container:t,oAuth:e}):t.remove()}_searchAfterCreate(e){return t(this,void 0,void 0,(function*(){const{searchViewModel:t,view:i}=this;t?(t.view||(t.view=i),new((yield import("@arcgis/core/widgets/Search")).default)({container:e,viewModel:t})):e.remove()}))}_viewAfterCreate(t){this.view.container=t}};e([s({type:c})],E.prototype,"widgetInfos",void 0),e([s()],E.prototype,"_alerts",void 0),e([s()],E.prototype,"_actionBarActionGroups",void 0),e([s()],E.prototype,"_visibleWidget",void 0),e([s()],E.prototype,"_shellPanelWidgets",void 0),E=e([a("cov.layouts.MapApplication")],E);export default E;let O=class extends l{constructor(t){super(t)}render(){const{id:t,oAuth:e,oAuth:{signedIn:i,fullName:o,username:n,thumbnailUrl:a}}=this,s=`user_control_${t}`;return i?r("div",{class:b},r("calcite-avatar",{id:s,"full-name":o,thumbnail:a,role:"button"}),r("calcite-popover",{"auto-close":"",label:"Sign out",placement:"bottom","reference-element":s,"overlay-positioning":"fixed"},r("div",{class:y},r("div",null,o),r("span",null,n),r("calcite-button",{width:"full",onclick:e.signOut.bind(e)},"Sign out")))):r("div",{class:b},r("calcite-icon",{id:s,icon:"sign-in",role:"button",onclick:e.signIn.bind(e)}),r("calcite-tooltip",{label:"Sign in",placement:"bottom","reference-element":s,"overlay-positioning":"fixed"},"Sign in"))}};O=e([a("UserControl")],O);