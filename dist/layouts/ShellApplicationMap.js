/* His name was Bruce McNair. Copyright 2024 City of Vernonia, Oregon. */
import{__awaiter as e,__decorate as t}from"tslib";import i from"@arcgis/core/config";import o from"@arcgis/core/identity/IdentityManager";import{watch as n}from"@arcgis/core/core/reactiveUtils";import{subclass as l,property as a}from"@arcgis/core/core/accessorSupport/decorators";import s from"@arcgis/core/core/Collection";import r from"@arcgis/core/widgets/Widget";import{tsx as c}from"@arcgis/core/widgets/support/widget";import d from"../support/logo";import p from"../widgets/Loader";import h from"../widgets/Disclaimer";import u from"../widgets/ViewControl2D";import g from"../support/basemapToggle";import{subscribe as v}from"pubsub-js";const f="cov-layouts--shell-application-map_header",m="cov-layouts--shell-application-map_header--title",b="cov-layouts--shell-application-map_header--controls",_="cov-layouts--shell-application-map_header--search",w="cov-layouts--shell-application-map_header--user-control",y="cov-layouts--shell-application-map_header--user-control--popover",k="cov-layouts--shell-application-map_view";let C=0;const W="shell-application-alert";let E=class extends r{constructor(e){super(e),this.container=document.createElement("calcite-shell"),this.contentBehind=!0,this.disclaimerOptions={},this.headerOptions={},this.includeDisclaimer=!0,this.includeHeader=!0,this.loaderOptions={},this.panelPosition="start",this.title="City of Vernonia",this.viewControlOptions={},this._actionGroups=new s,this._alerts=new s,this._panelWidgets=new s,this._visiblePanelWidget=null;const{container:t}=this;t.contentBehind=void 0!==e.contentBehind?e.contentBehind:this.contentBehind,document.body.append(t)}postInitialize(){return e(this,void 0,void 0,(function*(){const{disclaimerOptions:e,loaderOptions:t,nextBasemap:n,panelPosition:l,panelWidgets:a,shellPanel:s,title:r,view:c,view:{ui:d},viewControlOptions:f}=this,m=new p(t.title?t:Object.assign(Object.assign({},t),{title:r}));if(d.remove("zoom"),"2d"===c.type&&d.add(new u(Object.assign({view:c},f)),"start"===l?"top-right":"top-left"),n&&g(c,n,"start"===l?"bottom-left":"bottom-right"),!s&&a&&a.length){const e=a.find((e=>!0===e.open));e&&"calcite-modal"!==e.type&&(this._visiblePanelWidget=e.widget.id),this._createShellPanelWidgets(a)}v(W,((e,t)=>{this._alertEvent(t)}));let{includeDisclaimer:b}=this;try{(yield o.checkSignInStatus(i.portalUrl))&&(b=!1)}catch(e){b=!0}b&&!h.isAccepted()&&new h(e),yield c.when(),m.end()}))}showAlert(e){this._alertEvent(e)}showWidget(e){this._visiblePanelWidget=e}_actionAfterCreate(e,t,i){i.addEventListener("click",(()=>{e?e.open=!0:this._visiblePanelWidget=this._visiblePanelWidget===t?null:t})),this.addHandles(n((()=>this._visiblePanelWidget),(e=>{i.active=e===t})))}_alertEvent(e){const{_alerts:t}=this,{duration:i,icon:o,kind:n,label:l,link:a,message:s,title:r}=e;t.add(c("calcite-alert",{key:C++,icon:o||null,kind:n||"brand",open:"",label:l,"auto-close":i?"":null,"auto-close-duration":i||null},r?c("div",{slot:"title"},r):null,c("div",{slot:"message"},s),a?c("calcite-link",{href:a.href||null,slot:"link",target:a.href?"_blank":null,onclick:e=>{e.click&&e.addEventListener("click",e.click)}},a.text):null))}_createActionGroups(e){const{_actionGroups:t}=this;let i=[];e.filter((e=>!0!==e.actionEnd)).forEach(((e,o,n)=>{const{action:l,groupEnd:a}=e;i.push(l),!0!==a&&o+1!==n.length||(t.add(c("calcite-action-group",{key:C++},i)),i=[])}));const o=e.filter((e=>!0===e.actionEnd)).map((e=>e.action));o.length&&t.add(c("calcite-action-group",{key:C++,slot:"actions-end"},o))}_createShellPanelWidgets(e){const{_visiblePanelWidget:t,_panelWidgets:i}=this,o=[];e.forEach((e=>{const{icon:n,text:l,widget:a,type:s,groupEnd:r,actionEnd:d}=e,p="calcite-modal"===s?document.createElement("calcite-modal"):null;if(o.push({action:c("calcite-action",{active:a.id===t,icon:n,key:C++,text:l,afterCreate:this._actionAfterCreate.bind(this,p,a.id)},c("calcite-tooltip",{"close-on-click":"",label:l,"overlay-positioning":"fixed",slot:"tooltip"},c("span",null,l))),groupEnd:r,actionEnd:d}),p)document.body.append(p),a.container=p,p.addEventListener("calciteModalOpen",(()=>{a.onShow&&"function"==typeof a.onShow&&a.onShow()})),p.addEventListener("calciteModalClose",(()=>{a.onHide&&"function"==typeof a.onHide&&a.onHide()}));else{const e=a.id!==t;let o;switch(s){case"calcite-panel":o=c("calcite-panel",{key:C++,hidden:e,afterCreate:this._widgetAfterCreate.bind(this,a)});break;case"calcite-flow":o=c("calcite-flow",{key:C++,hidden:e,afterCreate:this._widgetAfterCreate.bind(this,a)});break;default:o=c("div",{key:C++,hidden:e,afterCreate:this._widgetAfterCreate.bind(this,a)})}i.add(o)}})),this._createActionGroups(o)}_widgetAfterCreate(e,t){e.container=t,this.addHandles([e.on(W,this._alertEvent.bind(this)),n((()=>this._visiblePanelWidget),((i,o)=>{t.hidden=i!==e.id,i===e.id&&e.onShow&&"function"==typeof e.onShow&&e.onShow(),o&&o===e.id&&e.onHide&&"function"==typeof e.onHide&&e.onHide()}))])}render(){const{contentBehind:e,footer:t,header:i,panelPosition:o,shellPanel:n,view:l,_alerts:a,_actionGroups:s,_panelWidgets:r,_visiblePanelWidget:d}=this;return c("calcite-shell",null,i?c("div",{slot:"header",afterCreate:e=>{i.container=e}}):this._renderHeader(),n?c("calcite-shell-panel",{afterCreate:e=>{n.container=e,e.position=o,e.slot=`panel-${o}`}}):null,s.length?c("calcite-shell-panel",{"display-mode":e?"float":"dock",collapsed:!d,position:o,slot:`panel-${o}`},c("calcite-action-bar",{slot:"action-bar",afterCreate:t=>{if(!e)return;const i=()=>{const e=t.getBoundingClientRect().width;l.padding=Object.assign(Object.assign({},l.padding),"start"===o?{left:e}:{right:e})};i(),new ResizeObserver((()=>{i()})).observe(t)}},s.toArray()),r.toArray()):null,c("div",{class:k,afterCreate:e=>{this.view.container=e}}),c("div",{slot:"alerts"},a.toArray()),t?c("div",{slot:"footer",afterCreate:e=>{i.container=e}}):null)}_renderHeader(){const{title:t,includeHeader:i,headerOptions:{title:o,searchViewModel:n,logoUrl:l,oAuth:a}}=this;return i?c("div",{class:f,slot:"header"},c("div",{class:m},!1!==l?c("img",{src:l||d}):null,o||t?c("div",null,o||t):null),c("div",{class:b},n?c("div",{class:_,afterCreate:t=>e(this,void 0,void 0,(function*(){new((yield import("@arcgis/core/widgets/Search")).default)({container:t,viewModel:n})}))}):null,a?c("div",{afterCreate:e=>{new A({container:e,oAuth:a})}}):null)):null}};t([a({type:s})],E.prototype,"panelWidgets",void 0),t([a()],E.prototype,"_actionGroups",void 0),t([a()],E.prototype,"_alerts",void 0),t([a()],E.prototype,"_panelWidgets",void 0),t([a()],E.prototype,"_visiblePanelWidget",void 0),E=t([l("cov.layouts.ShellApplicationMap")],E);export default E;let A=class extends r{constructor(e){super(e)}render(){const{id:e,oAuth:t,oAuth:{signedIn:i,fullName:o,username:n,thumbnailUrl:l}}=this,a=`user_control_${e}`;return i?c("div",{class:w},c("calcite-avatar",{id:a,"full-name":o,thumbnail:l,role:"button"}),c("calcite-popover",{"auto-close":"",label:"Sign out",placement:"bottom","reference-element":a,"overlay-positioning":"fixed"},c("div",{class:y},c("div",null,o),c("span",null,n),c("calcite-button",{width:"full",onclick:t.signOut.bind(t)},"Sign out")))):c("div",{class:w},c("calcite-icon",{id:a,icon:"sign-in",role:"button",onclick:t.signIn.bind(t)}),c("calcite-tooltip",{label:"Sign in",placement:"bottom","reference-element":a,"overlay-positioning":"fixed"},"Sign in"))}};A=t([l("HeaderUserControl")],A);